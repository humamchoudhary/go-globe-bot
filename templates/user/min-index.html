{% extends 'user/base-min.html' %} {% block content %}
<style>
    #send-btn {
        transition: all 0.3s ease-in-out 0.1s;
    }

    #send-btn:hover {
        opacity: 0.7;
    }
</style>

<!-- AI Chat Bot Page -->
<div style="display: flex; position: relative; margin-bottom:10px">
    <div
        style="min-height: 100%; padding-left: 0.5rem; padding-right: 0.5rem; width: 100%; display: flex; flex-direction: column; position: relative; z-index: 3;">
        <!-- Chat Messages -->
        {% if chat %}
        <div id="messageArea" data-backend-url="{{settings['backend_url']}}" data-room-id="{{chat.room_id}}"
            data-username="{{username}}"
            style="display: flex; position: relative;min-height:300px ; height:100%; flex-direction:column; gap:20px; overflow-y: auto; ">
            {% for message in chat.messages %}
            {% include 'user/fragments/chat_message.html' %}
            {% endfor %}
        </div>
        {% endif %}

        {% if chat %}
        <div
            style="margin-top: auto;position: sticky;bottom: 0;padding: 10px 0px 0px 0px;background-color: var(--goglobe-site-bg-color);">
            <div style="display: flex; flex-direction: row; width: 100%; gap: 10px; align-items: center">
                <textarea rows="1" name="message" placeholder="Send a message..." id="fn__chat_textarea" style="
                                    border-radius: 6px;
                                    box-sizing: border-box;
                                    background-color: transparent;
                                    outline: none;
                                    display: block;
                                    width: 70%;
                                    padding: 12px 12px 12px;
                                    font-size: 14px;
                                    font-weight: 400;
                                    line-height: 22px;
                                    max-height: 170px;
                                    font-family: var(--goglobe-heading-font-family);
                                    resize: none;
                                    overflow-y: hidden;
                                    color: var(--goglobe-heading-color);
                                    transition: border-color 0.2s ease;
                                    " onkeyup="handleKeyPress(event); checkInputValue();"></textarea>
                <button id="send-btn"
                    style="width: 50px;height: 45px;padding: 0;margin: 0;border-radius: 5px;outline: none;cursor: pointer;border: none;background-color: var(--goglobe-main-color);color: white;transition: all 0.3s ease;"
                    onclick="sendMessage()">
                    <img src="{{settings['backend_url']}}/static/svg/enter.svg" alt=""
                        style="color: #fff; width: 21px; height: 21px; filter: invert(1);">
                </button>
                <!-- <div id="ping-admin-btn"
                    style="display: flex;align-items: center;justify-content: center;border-radius: 5px;background-color: var(--goglobe-main-color);width: 44px;height: 45px;cursor: pointer;opacity: 1;"
                    title="Request Assistance" onmouseover="this.style.opacity='0.9';"
                    onmouseout="this.style.opacity='1';">
                    
                    
                </div> -->
                <div id="second-call-btn-target"></div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
<!-- Choice Overlay -->
<div id="choice-overlay" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--goglobe-site-bg-color);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    padding: 20px;
    box-sizing: border-box;
">
    <!-- Back and Close Buttons -->
    <div style="display: flex; justify-content: flex-end; align-items: center; gap: 15px; margin-bottom: 10px;">
        <!-- Back Button -->
        <div id="choice-back-btn" style="cursor: pointer; color: #FF5E00;" onmouseover="this.style.opacity=0.7"
            onmouseout="this.style.opacity=1" onclick="goBackFromChoice()">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M1.33333 5.66672L0.744165 6.25589L0.154999 5.66672L0.744165 5.07756L1.33333 5.66672ZM5.5 15.6667C5.27899 15.6667 5.06702 15.5789 4.91074 15.4226C4.75446 15.2664 4.66667 15.0544 4.66667 14.8334C4.66667 14.6124 4.75446 14.4004 4.91074 14.2441C5.06702 14.0879 5.27899 14.0001 5.5 14.0001V15.6667ZM4.91083 10.4226L0.744165 6.25589L1.9225 5.07756L6.08917 9.24422L4.91083 10.4226ZM0.744165 5.07756L4.91083 0.910889L6.08917 2.08922L1.9225 6.25589L0.744165 5.07756ZM1.33333 4.83339H10.0833V6.50005H1.33333V4.83339ZM10.0833 15.6667H5.5V14.0001H10.0833V15.6667ZM15.5 10.2501C15.5 11.6866 14.9293 13.0644 13.9135 14.0802C12.8977 15.096 11.5199 15.6667 10.0833 15.6667V14.0001C10.5758 14.0001 11.0634 13.9031 11.5184 13.7146C11.9734 13.5261 12.3868 13.2499 12.735 12.9017C13.0832 12.5535 13.3594 12.1401 13.5479 11.6851C13.7363 11.2301 13.8333 10.7425 13.8333 10.2501H15.5ZM10.0833 4.83339C11.5199 4.83339 12.8977 5.40407 13.9135 6.41989C14.9293 7.43572 15.5 8.81347 15.5 10.2501H13.8333C13.8333 9.7576 13.7363 9.26996 13.5479 8.81499C13.3594 8.36002 13.0832 7.94662 12.735 7.5984C12.3868 7.25019 11.9734 6.97396 11.5184 6.78551C11.0634 6.59705 10.5758 6.50005 10.0833 6.50005V4.83339Z"
                    fill="#FF5800" />
            </svg>
        </div>
        <!-- Close Button -->
        <div id="choice-close-btn" style="cursor: pointer; color: #FF5E00;" onmouseover="this.style.opacity=0.7"
            onmouseout="this.style.opacity=1" onclick="closeFromChoice()">
            <svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M1.66666 14.7916L0.208328 13.3333L6.04166 7.49992L0.208328 1.66659L1.66666 0.208252L7.49999 6.04159L13.3333 0.208252L14.7917 1.66659L8.95833 7.49992L14.7917 13.3333L13.3333 14.7916L7.49999 8.95825L1.66666 14.7916Z"
                    fill="#FF5800" />
            </svg>
        </div>
    </div>
    <div style="display:flex; flex-direction:row;gap:15px; margin-bottom:20px;">
        <svg width="57" height="56" viewBox="0 0 57 56" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
                d="M51.9725 32.2535C54.3799 19.3447 45.6728 6.89178 32.525 4.43975C19.3772 1.98772 6.7666 10.465 4.35916 23.3737C1.95171 36.2824 10.6589 48.7354 23.8067 51.1874L46.9641 55.5062L43.7422 46.1233C48.0544 42.5965 50.9659 37.6899 51.9725 32.2535Z"
                fill="white" />
            <path d="M14.9164 27.0168V40.5406H41.5974L41.474 27.0168L40.2 20.4509L17.1704 21.7249L14.9164 27.0168Z"
                fill="#F7D5B1" />
            <path
                d="M9.23244 16.1385L14.9164 27.0164L17.1703 21.7244L40.1999 20.4505L41.4739 27.0164L44.3159 17.2165L38.142 15.9425L40.1019 12.8066L36.721 13.2476L40.1509 8.54366L33.0951 11.7776L36.525 4.91772L26.1372 11.4836L25.1572 8.73966L9.23244 16.1385Z"
                fill="#52504D" />
            <path d="M14.9412 40.3388V46.0213H41.2018V40.3125L14.9412 40.3388Z" fill="white" />
            <path d="M17.6604 40.4421L28.2442 51.026L38.7301 40.4421H17.6604Z" fill="#E8EAEB" />
            <path d="M18.3463 40.4421L22.1683 44.9501L28.1462 40.5401L34.2221 44.9501L38.044 40.4421H18.3463Z"
                fill="white" />
            <path d="M28.1462 40.5403L26.0882 42.0103V42.5003H30.4001V42.0103L28.1462 40.5403Z" fill="#C95C1C" />
            <path d="M28.0715 50.5885H31.4968L30.4001 42.5002H26.0882L25.2171 50.5885H28.0715Z" fill="#FF5E00" />
            <path
                d="M28.3975 36.0812C30.3947 36.0812 32.2856 34.0523 32.0847 33.1945C31.8838 32.3367 30.3947 33.1945 28.3975 33.1945C26.4002 33.1945 24.9525 32.1927 24.852 33.1945C24.7516 34.1964 26.3588 35.9372 28.3975 36.0812Z"
                fill="#3B3731" />
            <path
                d="M20.6335 28.1925C21.283 28.1925 21.8095 27.666 21.8095 27.0166C21.8095 26.3671 21.283 25.8406 20.6335 25.8406C19.9841 25.8406 19.4576 26.3671 19.4576 27.0166C19.4576 27.666 19.9841 28.1925 20.6335 28.1925Z"
                fill="#3B3731" />
            <path
                d="M35.6275 28.1925C36.277 28.1925 36.8035 27.666 36.8035 27.0166C36.8035 26.3671 36.277 25.8406 35.6275 25.8406C34.978 25.8406 34.4515 26.3671 34.4515 27.0166C34.4515 27.666 34.978 28.1925 35.6275 28.1925Z"
                fill="#3B3731" />
        </svg>
        <p
            style="color: #FFF; font-size: 16px; font-style: normal; font-weight: 400; line-height: 20px; letter-spacing: -0.32px; margin-top: 9px;">
            Thanks {{ username }}!
            <br />Choose how you want to continue:</p>
    </div>

    <div style="display: flex; flex-direction: column; gap: 1rem; width: 100%;">
        <!-- Chat Option -->
        <button onclick="chooseChat()" class="chatbot-options-button" onMouseOver="this.style.opacity=0.8"
            onMouseOut="this.style.opacity=1">
            <svg width="16" height="16" viewBox="0 0 18 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M10.2916 13.4583C13.277 13.4583 14.7701 13.4583 15.6971 12.5305C16.625 11.6035 16.625 10.1104 16.625 7.12501C16.625 4.13963 16.625 2.64655 15.6971 1.71951C14.7701 0.791672 13.277 0.791672 10.2916 0.791672H7.12496C4.13958 0.791672 2.6465 0.791672 1.71946 1.71951C0.791626 2.64655 0.791626 4.13963 0.791626 7.12501C0.791626 10.1104 0.791626 11.6035 1.71946 12.5305C2.23642 13.0483 2.92913 13.277 3.95829 13.3776"
                    stroke="#FF5805" stroke-width="1.58333" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M8.70825 7.125V7.13292" stroke="#FF5805" stroke-width="1.58333" stroke-linecap="round"
                    stroke-linejoin="round" />
                <path d="M5.54163 7.125V7.13292" stroke="#FF5805" stroke-width="1.58333" stroke-linecap="round"
                    stroke-linejoin="round" />
                <path d="M11.8749 7.125V7.13292" stroke="#FF5805" stroke-width="1.58333" stroke-linecap="round"
                    stroke-linejoin="round" />
                <path
                    d="M10.2915 13.4583C9.31303 13.4583 8.23478 13.8542 7.25074 14.3648C5.66899 15.1858 4.87812 15.5966 4.48862 15.3346C4.09912 15.0733 4.17274 14.2619 4.32078 12.6398L4.35403 12.2708"
                    stroke="#FF5805" stroke-width="1.58333" stroke-linecap="round" stroke-linejoin="round" />
            </svg>

            Chat with me for quick<br>answers
        </button>
        

        <!-- Voice Option -->
        <button class="chatbot-options-button" onMouseOver="this.style.opacity=0.8" onMouseOut="this.style.opacity=1">
            <span style="color: #FF5E00;">
                <svg width="16" height="16" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M7.76059 4.30935L5.0542 1.18554C4.7422 0.825559 4.1702 0.827159 3.80781 1.19034L1.58222 3.4198C0.919822 4.08296 0.730223 5.0677 1.11342 5.85726C3.4027 10.5969 7.22542 14.4248 11.9622 16.7206C12.751 17.1038 13.735 16.9142 14.3973 16.251L16.6437 14.0008C17.0077 13.6368 17.0085 13.0616 16.6453 12.7496L13.5094 10.0578C13.1814 9.77622 12.6718 9.81302 12.343 10.1426L11.2518 11.2353C11.1959 11.2939 11.1224 11.3325 11.0424 11.3452C10.9625 11.3579 10.8806 11.344 10.8094 11.3057C9.02573 10.2787 7.54618 8.79726 6.52139 7.01239C6.48301 6.94099 6.46912 6.85898 6.48183 6.77893C6.49455 6.69887 6.53318 6.6252 6.59179 6.56921L7.67979 5.48048C8.00938 5.1493 8.04538 4.63813 7.76059 4.30935Z"
                        stroke="#FF5805" stroke-width="1.83333" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </span>
            <!-- Hidden Vapi Button Target -->
            <div id="call-btn-target"></div>
            
        </button>
    </div>


</div>

<script>
    function getRoomId() {
        const messageArea = document.getElementById('messageArea');
        return messageArea ? messageArea.dataset.roomId : null;
    }

    function chooseChat() {
        // Click the Vapi primary button before anything else
        const vapiBtn = document.getElementById('vapi-support-btn-primary');
        if (
            vapiBtn &&
            vapiBtn.title &&
            vapiBtn.title.toLowerCase().includes('click to cancel')
        ) {
            vapiBtn.click();
        }
        else {
            console.log("Vapi button not found or not in active call state.");
        }
        const roomId = getRoomId();
        if (roomId) localStorage.setItem('choice_made_' + roomId, 'true');
        document.getElementById('choice-overlay').style.display = 'none';
    }


    function switchToChat() {
        const roomId = getRoomId();
        if (roomId) localStorage.setItem('choice_made_' + roomId, 'true');

        // Remove listeners to prevent duplicates if possible, or just hide overlay
        document.getElementById('choice-overlay').style.display = 'none';
    }

    // Go back to onboarding from choice overlay
    function goBackFromChoice() {
        // Click the Vapi primary button before anything else
        const vapiBtn = document.getElementById('vapi-support-btn-primary');
        if (
            vapiBtn &&
            vapiBtn.title &&
            vapiBtn.title.toLowerCase().includes('click to cancel')
        ) {
            vapiBtn.click();
        }
        else {
            console.log("Vapi button not found or not in active call state.");
        }

        const messageArea = document.getElementById('messageArea');
        const backendUrl = messageArea ? messageArea.dataset.backendUrl : '';
        const chatbox = document.getElementById('chatbox');
        const overlay = document.getElementById('choice-overlay');

        // Hide the overlay first to prevent visual artifacts
        if (overlay) {
            overlay.style.display = 'none';
        }

        if (chatbox && backendUrl) {
            // Use HTMX to load the onboarding page (same as the header's return button)
            htmx.ajax('GET', backendUrl + '/min/onboarding', { target: '#chatbox', swap: 'innerHTML' });
        }
    }

    // Close the chat widget from choice overlay
    function closeFromChoice() {
        // Trigger the main close button's click handler
        const closeBtn = document.getElementById('close-chat');
        if (closeBtn) {
            closeBtn.click();
        }
    }
</script>
<!-- vapi script -->
<script>
    (function () {
        console.log("Loading Vapi script...");

        if (typeof window.VAPI_ASSISTANT === "undefined") window.VAPI_ASSISTANT = "{{ assistant}}";
        if (typeof window.VAPI_KEY === "undefined") window.VAPI_KEY = "{{ api_key}}";

        const vapiSrc = "https://cdn.jsdelivr.net/gh/VapiAI/html-script-tag@latest/dist/assets/index.js";
        const DEFAULT_VAPI_BUTTON_ID = "vapi-support-btn";

        // Two different configs (edit as you like)
        const primaryButtonConfig = {
            position: "top-left",
            offset: "10px",
            width: "20px",
            height: "30px",
            idle: {
                type: "pill",
                title: "Talk with Ana by voice",
                subtitle: "detailed help",
                icon: "https://unpkg.com/lucide-static@0.321.0/icons/phone.svg",
            },
            loading: {
                type: "pill",
                title: "Connecting...",
                subtitle: " ",
                icon: "https://unpkg.com/lucide-static@0.321.0/icons/loader-2.svg",
            },
            active: {
                type: "pill",
                title: "Call in progress (click to cancel)",
                subtitle: " ",
                icon: "https://unpkg.com/lucide-static@0.321.0/icons/phone-off.svg",
            },
        };

        const secondaryButtonConfig = {
            position: "top-left",
            offset: "0px",
            width: "44px",
            height: "45px",
            idle: {
                type: "round",
                title: "Call support",
                subtitle: "",
                color: "#FFFFFF",
                icon: "{{ settings['backend_url'] }}/static/svg/call-white.svg",
            },
            loading: {
                type: "round",
                title: "Connecting...",
                subtitle: "",
                color: "#FFFFFF",
                icon: "{{ settings['backend_url'] }}/static/svg/loader-white.svg",
            },
            active: {
                type: "round",
                title: "End call",
                subtitle: "",
                color: "#FFFFFF",
                icon: "{{ settings['backend_url'] }}/static/svg/cut-call-white.svg",
            },
        };

        function ensureScriptLoaded(cb) {
            if (window.vapiSDK && typeof window.vapiSDK.run === "function") return cb();

            let script = document.querySelector(`script[src="${vapiSrc}"]`);
            if (!script) {
                script = document.createElement("script");
                script.src = vapiSrc;
                script.defer = true;
                script.async = true;
                document.head.appendChild(script);
            }
            script.addEventListener("load", cb, { once: true });
        }

        function waitForButtonById(id, timeoutMs = 15000) {
            return new Promise((resolve, reject) => {
                const existing = document.getElementById(id);
                if (existing) return resolve(existing);

                const obs = new MutationObserver(() => {
                    const el = document.getElementById(id);
                    if (el) {
                        obs.disconnect();
                        resolve(el);
                    }
                });

                obs.observe(document.documentElement, { childList: true, subtree: true });

                setTimeout(() => {
                    obs.disconnect();
                    reject(new Error(`Timed out waiting for #${id}`));
                }, timeoutMs);
            });
        }

        function mountButtonIntoTarget(buttonEl, targetId) {
            const target = document.getElementById(targetId);
            if (!target) return;

            // Prevent wrapper clicks (e.g., pingAdmin) when clicking the Vapi button
            buttonEl.addEventListener("click", (e) => {
                e.stopPropagation();
            });

            // Avoid form submit behavior
            if (buttonEl.tagName && buttonEl.tagName.toLowerCase() === "button") {
                buttonEl.setAttribute("type", "button");
            }

            if (buttonEl.parentElement !== target) target.appendChild(buttonEl);
        }

        async function initOneVapiButton({ instanceKey, assistant, config, targetId, finalButtonId }) {
            // If instance already created (HTMX swaps), just re-mount existing button
            const existingFinalBtn = document.getElementById(finalButtonId);
            if (window[instanceKey] && existingFinalBtn) {
                mountButtonIntoTarget(existingFinalBtn, targetId);
                return;
            }

            const vapi = window.vapiSDK?.run?.({
                apiKey: window.VAPI_KEY,
                assistant,
                config,
            });

            if (!vapi) return;

            window[instanceKey] = vapi;

            // Wait for Vapi to inject its default button, then rename + mount it
            const btn = await waitForButtonById(DEFAULT_VAPI_BUTTON_ID);
            btn.id = finalButtonId;

            mountButtonIntoTarget(btn, targetId);

            // Optional logging (keep minimal)
            vapi.on("error", (e) => console.error(e));
        }

        function initBoth() {
            // IMPORTANT: init primary first, rename its button away from `#vapi-support-btn`,
            // then init secondary so it can create a new `#vapi-support-btn`.
            initOneVapiButton({
                instanceKey: "vapiInstancePrimary",
                assistant: window.VAPI_ASSISTANT,
                config: primaryButtonConfig,
                targetId: "call-btn-target",
                finalButtonId: "vapi-support-btn-primary",
            }).then(() => {
                return initOneVapiButton({
                    instanceKey: "vapiInstanceSecondary",
                    assistant: window.VAPI_ASSISTANT, // or set a different assistant for the second button
                    config: secondaryButtonConfig,
                    targetId: "second-call-btn-target",
                    finalButtonId: "vapi-support-btn-secondary",
                });
            }).catch((e) => console.error(e));
        }

        ensureScriptLoaded(initBoth);
    })();
</script>

{% endblock %}

{% block scripts %}
<script>
    function scrollToBottom() {
        const messageArea = document.getElementById('messageArea');
        if (messageArea && messageArea.lastElementChild) {
            messageArea.lastElementChild.scrollIntoView({ behavior: "smooth" });
        }
    }

    function checkInputValue() {
        const textarea = document.getElementById('fn__chat_textarea');
        const sendBtn = document.getElementById('send-btn');
        if (textarea.value.trim() !== '') {
            sendBtn.style.cursor = 'pointer';
        } else {
            sendBtn.style.cursor = 'not-allowed';
        }
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter' && document.getElementById('fn__chat_textarea').value.trim() !== '') {
            sendMessage();
        }
    }

    function sendMessage() {
        const textarea = document.getElementById('fn__chat_textarea');
        const message = textarea.value.trim();
        const messageArea = document.getElementById('messageArea');

        if (!message) return;

        // Get values from data attributes
        const backendUrl = messageArea.dataset.backendUrl;
        const roomId = messageArea.dataset.roomId;

        // Clear immediately for better UX
        textarea.value = '';

        fetch(`${backendUrl}/min/chat/${roomId}/send_message`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({ message: message }),
            credentials: 'include'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                scrollToBottom();
            })
            .catch(error => {
                // Restore message on error
                textarea.value = message;
                console.error('Error sending message:', error);
            });
    }

    function pingAdmin() {
        const messageArea = document.getElementById('messageArea');
        const backendUrl = messageArea.dataset.backendUrl;
        const roomId = messageArea.dataset.roomId;

        fetch(`${backendUrl}/min/chat/${roomId}/ping_admin`, {
            method: 'POST',
            credentials: 'include'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to ping admin');
                }
                console.log('Admin notified');
            })
            .catch(error => {
                console.error('Error pinging admin:', error);
            });
    }

</script>
{% if chat %}
<script>
    function initChat() {
        const messageArea = document.getElementById('messageArea');
        const roomId = messageArea.dataset.roomId;
        const backendUrl = messageArea.dataset.backendUrl;
        const username = messageArea.dataset.username;
        console.log("init")
        // Use the backendUrl from data attribute
        const socket = io(backendUrl, { withCredentials: true });

        socket.on('connect', function () {
            console.log('Socket connected to room:', roomId);
            socket.emit('join_min', { room: roomId });
        });

        socket.on('new_message', function (data) {
            console.log("new_message received:", data);
            appendMessage(data);
        }, { room: roomId });

        socket.on('disconnect', function () {
            console.log('Socket disconnected');
        });

        socket.on('error', function (error) {
            console.error('Socket error:', error);
        });
    }

    function appendMessage(message) {
        const messagesContainer = document.getElementById('messageArea');
        const username = messagesContainer.dataset.username;
        const backendUrl = messagesContainer.dataset.backendUrl;
        const roomId = messagesContainer.dataset.roomId;

        // Create a temporary div for processing markdown
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = marked.parse(message.content);

        // Fix links in the rendered content
        fixAllLinks(tempDiv);

        // Play notification sound for messages from others
        if (message.sender !== username) {
            try {
                const audio = new Audio(`${backendUrl}/static/sounds/message.wav`);
                audio.play().catch(e => console.log('Audio play failed:', e));
            } catch (e) {
                console.log('Audio error:', e);
            }
        }

        const messageHTML = `
        <div style="position: relative; width: fit-content; max-width: 85%; align-self:${message.sender === username ? 'flex-end' : 'flex-start'}; display: flex; flex-direction: row; gap: 10px; align-items: flex-start;">
      ${message.sender === "bot" ? `
        <div style="width: 40px; height: 40px; flex-shrink: 0;">
          <!-- Bot Avatar SVG -->
<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M36.8532 22.8708C38.5603 13.7173 32.3861 4.88706 23.0631 3.14835C13.7402 1.40964 4.79815 7.42077 3.09105 16.5742C1.38396 25.7276 7.55813 34.5579 16.8811 36.2966L33.3017 39.359L31.0172 32.7057C34.0749 30.2049 36.1394 26.7257 36.8532 22.8708Z" fill="white"/> <path d="M10.5771 19.1575V28.7471H29.4963L29.4088 19.1575L28.5054 14.5017L12.1753 15.4051L10.5771 19.1575Z" fill="#F7D5B1"/> <path d="M6.54663 11.4439L10.577 19.1572L12.1753 15.4048L28.5053 14.5014L29.4087 19.1572L31.4239 12.2083L27.0461 11.3049L28.4359 9.08122L26.0385 9.39392L28.4706 6.05842L23.4674 8.35158L25.8995 3.4873L18.5336 8.14311L17.8387 6.1974L6.54663 11.4439Z" fill="#52504D"/> <path d="M10.5947 28.6041V32.6335H29.2158V28.5854L10.5947 28.6041Z" fill="white"/> <path d="M12.5228 28.6772L20.0277 36.1821L27.4631 28.6772H12.5228Z" fill="#E8EAEB"/> <path d="M13.0092 28.6772L15.7193 31.8738L19.9581 28.7467L24.2665 31.8738L26.9766 28.6772H13.0092Z" fill="white"/> <path d="M19.9582 28.7468L18.4989 29.7892V30.1366H21.5564V29.7892L19.9582 28.7468Z" fill="#C95C1C"/> <path d="M19.9052 35.872H22.334L21.5564 30.1367H18.4989L17.8812 35.872H19.9052Z" fill="#FF5E00"/> <path d="M20.1363 25.5851C21.5526 25.5851 22.8934 24.1464 22.7509 23.5381C22.6085 22.9299 21.5526 23.5381 20.1363 23.5381C18.7201 23.5381 17.6935 22.8278 17.6223 23.5381C17.5511 24.2485 18.6908 25.4829 20.1363 25.5851Z" fill="#3B3731"/> <path d="M14.631 19.9912C15.0916 19.9912 15.4649 19.6179 15.4649 19.1574C15.4649 18.6968 15.0916 18.3235 14.631 18.3235C14.1705 18.3235 13.7971 18.6968 13.7971 19.1574C13.7971 19.6179 14.1705 19.9912 14.631 19.9912Z" fill="#3B3731"/> <path d="M25.2631 19.9912C25.7236 19.9912 26.097 19.6179 26.097 19.1574C26.097 18.6968 25.7236 18.3235 25.2631 18.3235C24.8026 18.3235 24.4292 18.6968 24.4292 19.1574C24.4292 19.6179 24.8026 19.9912 25.2631 19.9912Z" fill="#3B3731"/> <path d="M10.5771 19.1575V28.7471H29.4963L29.4088 19.1575L28.5054 14.5017L12.1753 15.4051L10.5771 19.1575Z" fill="#F7D5B1"/> <path d="M6.54663 11.4439L10.577 19.1572L12.1753 15.4048L28.5053 14.5014L29.4087 19.1572L31.4239 12.2083L27.0461 11.3049L28.4359 9.08122L26.0385 9.39392L28.4706 6.05842L23.4674 8.35158L25.8995 3.4873L18.5336 8.14311L17.8387 6.1974L6.54663 11.4439Z" fill="#52504D"/> <path d="M10.5947 28.6041V32.6335H29.2158V28.5854L10.5947 28.6041Z" fill="white"/> <path d="M12.5228 28.6772L20.0277 36.1821L27.4631 28.6772H12.5228Z" fill="#E8EAEB"/> <path d="M13.0092 28.6772L15.7193 31.8738L19.9581 28.7467L24.2665 31.8738L26.9766 28.6772H13.0092Z" fill="white"/> <path d="M19.9582 28.7468L18.4989 29.7892V30.1366H21.5564V29.7892L19.9582 28.7468Z" fill="#C95C1C"/> <path d="M19.9052 35.872H22.334L21.5564 30.1367H18.4989L17.8812 35.872H19.9052Z" fill="#FF5E00"/> <path d="M20.1363 25.5851C21.5526 25.5851 22.8934 24.1464 22.7509 23.5381C22.6085 22.9299 21.5526 23.5381 20.1363 23.5381C18.7201 23.5381 17.6935 22.8278 17.6223 23.5381C17.5511 24.2485 18.6908 25.4829 20.1363 25.5851Z" fill="#3B3731"/> <path d="M14.631 19.9912C15.0916 19.9912 15.4649 19.6179 15.4649 19.1574C15.4649 18.6968 15.0916 18.3235 14.631 18.3235C14.1705 18.3235 13.7971 18.6968 13.7971 19.1574C13.7971 19.6179 14.1705 19.9912 14.631 19.9912Z" fill="#3B3731"/> <path d="M25.2631 19.9912C25.7236 19.9912 26.097 19.6179 26.097 19.1574C26.097 18.6968 25.7236 18.3235 25.2631 18.3235C24.8026 18.3235 24.4292 18.6968 24.4292 19.1574C24.4292 19.6179 24.8026 19.9912 25.2631 19.9912Z" fill="#3B3731"/> </svg>
        </div>
      ` : ""}

      <div class="md-content" 
      
      style="padding: 0px 10px; border-radius: 5px; font-size: 16px; font-weight: 400;
             font-family: var(--goglobe-heading-font-family); 
             background-color:  ${message.sender === username ? '#001523' : 'var(--goglobe-some-r-bg-color)'};
             color: var(--goglobe-heading-color); 
             border: 0.5px solid var(--goglobe-border-color);
width:85%;
word-wrap: break-word;

overflow-wrap: break-word
"
>



        ${tempDiv.innerHTML}
      </div>
    </div>
    `;

        messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
        scrollToBottom();
    }

    function fixAllLinks(element) {
        const links = element.querySelectorAll('a');
        links.forEach(link => {
            link.setAttribute('target', '_blank');
            link.setAttribute('rel', 'noopener noreferrer');
            let href = link.getAttribute('href');
            if (href && !/^https?:\/\//i.test(href)) {
                link.setAttribute('href', 'https://' + href);
            }
        });
    }
</script>
{% endif %}

{% if chat %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
    function showReturnChatButton() {
        let returnButton = document.getElementById('return-chat');
        console.log("return show")
        if (returnButton) {
            returnButton.style.display = 'block';

            // Make sure HTMX processes the button
            if (typeof htmx !== 'undefined') {
                htmx.process(returnButton);
            }
        }
    }



    showReturnChatButton();
    initChat();
    scrollToBottom();

    // Initialize everything when the page loads
    document.addEventListener('DOMContentLoaded', function () {
        showReturnChatButton();
        initChat();
        scrollToBottom();

        // Check for persistent choice
        const messageArea = document.getElementById('messageArea');
        if (messageArea) {
            const roomId = messageArea.dataset.roomId;
            if (localStorage.getItem('choice_made_' + roomId)) {
                // User has already made a choice/dismissed the overlay
                const overlay = document.getElementById('choice-overlay');
                if (overlay) overlay.style.display = 'none';
            }

            console.log('Chat configuration:', {
                backendUrl: messageArea.dataset.backendUrl,
                roomId: roomId,
                username: messageArea.dataset.username
            });
        }
    });
</script>
{% endif %}
{% endblock %}