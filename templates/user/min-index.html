{% extends 'user/base-min.html' %} {% block content %}
<!-- AI Chat Bot Page -->
<div style="display: flex; position: relative; margin-bottom:10px">
  <div style="min-height: 100%; padding-left: 0.5rem; padding-right: 0.5rem; width: 100%; display: flex; flex-direction: column; position: relative; z-index: 3;">
    <!-- Chat Messages -->
    {% if chat %}
        <div id="messageArea" style="display: flex; position: relative;min-height:300px ; height:100%; flex-direction:column; gap:20px; overflow-y: auto; ">
          {% for message in chat.messages %} 
          {% include 'user/fragments/chat_message.html' %}
          {% endfor %}
        </div>
    {% endif %} 
    
    {% if chat %}
    <div style="margin-top: auto; position: sticky; bottom: -10px; padding: 10px 0px 0px 0px; background-color: var(--goglobe-site-bg-color);">
      <div style="display: flex; flex-direction: row; width: 100%; gap: 10px">
        <div style="width: 100%; height: fit-content; position: relative">
          <textarea
            rows="1"
            name="message"
            placeholder="Send a message..."
            id="fn__chat_textarea"
            style="min-height: 0px; margin-bottom: 0px; border-radius: 6px; border: 2px solid var(--goglobe-border-color);box-sizing: border-box ; background-color: transparent; outline: none; display: block; width: 100%; padding: 14px 20px 12px; padding-right: 72px; font-size: 14px; font-weight: 400; line-height: 22px; max-height: 170px; font-family: var(--goglobe-heading-font-family); resize: none; overflow-y: hidden; color: var(--goglobe-heading-color);"
            onkeyup="handleKeyPress(event); checkInputValue();"
          ></textarea>
          <button id="send-btn" style="position: absolute; width: 50px; height: 35px; bottom: 8px; right: 8px; padding: 0; margin: 0; border-radius: 5px; outline: none; cursor: pointer; border: none; background-color: var(--goglobe-main-color); display: flex; align-items: center; justify-content: center; color: white; transition: all 0.3s ease;" onclick="sendMessage()">
            <img
              src="{{ settings['backend_url'] }}{{ url_for('static', filename='svg/enter.svg') }}"
              alt=""
              style="color: #fff; width: 21px; height: 21px; filter: invert(1);"
            />
          </button>
        </div>
        <div
          id="ping-admin-btn"
          style="
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.25rem;
            border-radius: 9999px;
            border: 0.5px solid var(--goglobe-border-color);
            transition: all 200ms;
            position: relative;
            width: 40px;
            height:40px;
            cursor: pointer;
          "
          title="Request Assistance"
          onclick="pingAdmin()"
          onmouseover="this.style.backgroundColor='var(--goglobe-main-color)'; this.style.borderColor='var(--goglobe-hover-color)';"
          onmouseout="this.style.backgroundColor=''; this.style.borderColor='var(--goglobe-border-color)';"
        >
          <img
            style="border-radius: 9999px; min-width: 40px"
            src="{{ settings['backend_url'] }}{{ url_for('static', filename='img/ana.jpg') }}"
          />
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>


   function scrollToBottom(){

    const messageArea = document.getElementById('messageArea');
       console.log(messageArea)
    if (messageArea) {

        console.log('scroll')

messageArea.lastElementChild.scrollIntoView({ behavior: "smooth" });    
    }

   }
   // Handle textarea input to enable/disable send button

   function checkInputValue() {
     const textarea = document.getElementById('fn__chat_textarea');
     const sendBtn = document.getElementById('send-btn');
     if (textarea.value.trim() !== '') {
       // Add active styling
       sendBtn.style.cursor = 'pointer';
     } else {
       // Revert to default
       sendBtn.style.cursor = 'not-allowed';
     }
   }

  // document.getElementById('fn__chat_textarea').addEventListener('input', function() {
    // document.getElementById('fn__chat_button').disabled = this.value.trim() === '';
   //});
   // Handle Enter key press
   function handleKeyPress(event) {
     if (event.key === 'Enter' && document.getElementById('fn__chat_textarea').value.trim() !== '') {
       sendMessage();
     }
   }

   // Send message function
   function sendMessage() {
     const textarea = document.getElementById('fn__chat_textarea');
     const message = textarea.value.trim();

       textarea.value = '';
     if (!message) return;

     fetch('{{settings['backend_url']}}/min/chat/{{chat.chat_id}}/send_message', {
       method: 'POST',
       headers: {
         'Content-Type': 'application/x-www-form-urlencoded',
       },
       body: new URLSearchParams({
         message: message
       }),
       credentials: 'include'
     })
     .then(response => {
       if (!response.ok) {
         throw new Error('Network response was not ok');
       }
       scrollToBottom();
     })
     .catch(error => {

       textarea.value = message;
       console.error('Error sending message:', error);
     });
   }

   // Ping admin function
   function pingAdmin() {
       console.log('ping')
     fetch('{{settings['backend_url']}}/min/chat/{{chat.chat_id}}/ping_admin', {
       method: 'POST',
       credentials: 'include'
     })
     .then(response => {
       if (!response.ok) {
         throw new Error('Failed to ping admin');
       }
     })
     .catch(error => {
       console.error('Error pinging admin:', error);
     });
   }

   {% if chat %}
   function initChat() {
     // Function to fix all links in HTML content
     function fixAllLinks(element) {
       const links = element.querySelectorAll('a');

       links.forEach(link => {
         // Add target="_blank" to open in new tab
         link.setAttribute('target', '_blank');
         link.setAttribute('rel', 'noopener noreferrer');

         // Fix URLs without http/https
         let href = link.getAttribute('href');
         if (href && !/^https?:\/\//i.test(href)) {
           link.setAttribute('href', 'https://' + href);
         }
       });


     }

     // Apply to existing .md-content elements
     <!-- document.querySelectorAll('.md-content').forEach(el => { -->
     <!--   // Parse markdown -->
     <!--   el.innerHTML = marked.parse(el.textContent); -->
     <!---->
     <!--   // Fix links -->
     <!--   fixAllLinks(el); -->
     <!-- }); -->

     // Socket.io connection
     const roomId = "{{chat.room_id}}";

     const socket = io('{{settings["backend_url"]}}', {withCredentials: true});

     socket.on('connect', function() {
       socket.emit('join_min', {room: roomId});
     });

     socket.on('new_message', function(data) {

       appendMessage(data);
     });
   }

   function appendMessage(message) {
     const messagesContainer = document.getElementById('messageArea');

     // Create a temporary div for processing
     const tempDiv = document.createElement('div');
     tempDiv.innerHTML = marked.parse(message.content);
       console.log(message)

     // Fix links in the rendered content
     fixAllLinks(tempDiv);
       console.log(tempDiv)
       if(message.sender !== '{{username}}'){

           const audio = new Audio("{{settings["backend_url"]}}/static/sounds/message.wav");
        audio.play();
       }

const messageHTML = `
<div style="position: relative; width: fit-content;   
    align-self:${message.sender === '{{username}}' ? 'flex-end' : 'flex-start'};
    display:flex; flex-direction:row; gap:10px; align-items:flex-start;">

    ${ message.sender === "bot" ? `
      <div style="width:40px; height:40px; flex-shrink:0;">
<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M36.8532 22.8708C38.5603 13.7173 32.3861 4.88706 23.0631 3.14835C13.7402 1.40964 4.79815 7.42077 3.09105 16.5742C1.38396 25.7276 7.55813 34.5579 16.8811 36.2966L33.3017 39.359L31.0172 32.7057C34.0749 30.2049 36.1394 26.7257 36.8532 22.8708Z" fill="white"/>
  <path d="M10.5771 19.1575V28.7471H29.4963L29.4088 19.1575L28.5054 14.5017L12.1753 15.4051L10.5771 19.1575Z" fill="#F7D5B1"/>
  <path d="M6.54663 11.4439L10.577 19.1572L12.1753 15.4048L28.5053 14.5014L29.4087 19.1572L31.4239 12.2083L27.0461 11.3049L28.4359 9.08122L26.0385 9.39392L28.4706 6.05842L23.4674 8.35158L25.8995 3.4873L18.5336 8.14311L17.8387 6.1974L6.54663 11.4439Z" fill="#52504D"/>
  <path d="M10.5947 28.6041V32.6335H29.2158V28.5854L10.5947 28.6041Z" fill="white"/>
  <path d="M12.5228 28.6772L20.0277 36.1821L27.4631 28.6772H12.5228Z" fill="#E8EAEB"/>
  <path d="M13.0092 28.6772L15.7193 31.8738L19.9581 28.7467L24.2665 31.8738L26.9766 28.6772H13.0092Z" fill="white"/>
  <path d="M19.9582 28.7468L18.4989 29.7892V30.1366H21.5564V29.7892L19.9582 28.7468Z" fill="#C95C1C"/>
  <path d="M19.9052 35.872H22.334L21.5564 30.1367H18.4989L17.8812 35.872H19.9052Z" fill="#FF5E00"/>
  <path d="M20.1363 25.5851C21.5526 25.5851 22.8934 24.1464 22.7509 23.5381C22.6085 22.9299 21.5526 23.5381 20.1363 23.5381C18.7201 23.5381 17.6935 22.8278 17.6223 23.5381C17.5511 24.2485 18.6908 25.4829 20.1363 25.5851Z" fill="#3B3731"/>
  <path d="M14.631 19.9912C15.0916 19.9912 15.4649 19.6179 15.4649 19.1574C15.4649 18.6968 15.0916 18.3235 14.631 18.3235C14.1705 18.3235 13.7971 18.6968 13.7971 19.1574C13.7971 19.6179 14.1705 19.9912 14.631 19.9912Z" fill="#3B3731"/>
  <path d="M25.2631 19.9912C25.7236 19.9912 26.097 19.6179 26.097 19.1574C26.097 18.6968 25.7236 18.3235 25.2631 18.3235C24.8026 18.3235 24.4292 18.6968 24.4292 19.1574C24.4292 19.6179 24.8026 19.9912 25.2631 19.9912Z" fill="#3B3731"/>
  <path d="M10.5771 19.1575V28.7471H29.4963L29.4088 19.1575L28.5054 14.5017L12.1753 15.4051L10.5771 19.1575Z" fill="#F7D5B1"/>
  <path d="M6.54663 11.4439L10.577 19.1572L12.1753 15.4048L28.5053 14.5014L29.4087 19.1572L31.4239 12.2083L27.0461 11.3049L28.4359 9.08122L26.0385 9.39392L28.4706 6.05842L23.4674 8.35158L25.8995 3.4873L18.5336 8.14311L17.8387 6.1974L6.54663 11.4439Z" fill="#52504D"/>
  <path d="M10.5947 28.6041V32.6335H29.2158V28.5854L10.5947 28.6041Z" fill="white"/>
  <path d="M12.5228 28.6772L20.0277 36.1821L27.4631 28.6772H12.5228Z" fill="#E8EAEB"/>
  <path d="M13.0092 28.6772L15.7193 31.8738L19.9581 28.7467L24.2665 31.8738L26.9766 28.6772H13.0092Z" fill="white"/>
  <path d="M19.9582 28.7468L18.4989 29.7892V30.1366H21.5564V29.7892L19.9582 28.7468Z" fill="#C95C1C"/>
  <path d="M19.9052 35.872H22.334L21.5564 30.1367H18.4989L17.8812 35.872H19.9052Z" fill="#FF5E00"/>
  <path d="M20.1363 25.5851C21.5526 25.5851 22.8934 24.1464 22.7509 23.5381C22.6085 22.9299 21.5526 23.5381 20.1363 23.5381C18.7201 23.5381 17.6935 22.8278 17.6223 23.5381C17.5511 24.2485 18.6908 25.4829 20.1363 25.5851Z" fill="#3B3731"/>
  <path d="M14.631 19.9912C15.0916 19.9912 15.4649 19.6179 15.4649 19.1574C15.4649 18.6968 15.0916 18.3235 14.631 18.3235C14.1705 18.3235 13.7971 18.6968 13.7971 19.1574C13.7971 19.6179 14.1705 19.9912 14.631 19.9912Z" fill="#3B3731"/>
  <path d="M25.2631 19.9912C25.7236 19.9912 26.097 19.6179 26.097 19.1574C26.097 18.6968 25.7236 18.3235 25.2631 18.3235C24.8026 18.3235 24.4292 18.6968 24.4292 19.1574C24.4292 19.6179 24.8026 19.9912 25.2631 19.9912Z" fill="#3B3731"/>
</svg>
      </div>
    ` : "" }

    <div class="md-content"
      style="padding: 0px 10px; border-radius: 5px; font-size: 16px; font-weight: 400;
             font-family: var(--goglobe-heading-font-family); 
             background-color: ${message.sender === '{{username}}' ? '#001523' : 'var(--goglobe-some-r-bg-color)'};
             color: var(--goglobe-heading-color); 
             border: 0.5px solid var(--goglobe-border-color);">
      ${tempDiv.innerHTML}
    </div>
</div>
`;

     messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
     scrollToBottom();
   }

   // Function to fix all links in HTML content
   function fixAllLinks(element) {
     const links = element.querySelectorAll('a');

     links.forEach(link => {
       // Add target="_blank" to open in new tab
       link.setAttribute('target', '_blank');
       link.setAttribute('rel', 'noopener noreferrer');

       // Fix URLs without http/https
       let href = link.getAttribute('href');
       if (href && !/^https?:\/\//i.test(href)) {
         link.setAttribute('href', 'https://' + href);
       }
     });
   }
   {% endif %}
</script>

{% if chat %}

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
 
function showReturnChatButton() {
console.log("return ")
    let returnButton = document.getElementById('return-chat');
    if (returnButton) {
        returnButton.style.display = 'block';
        
        // Make sure HTMX processes the button
        if (typeof htmx !== 'undefined') {
            htmx.process(returnButton);
        }
    }
}

showReturnChatButton()

    // Initialize chat when the page loads
  initChat();

scrollToBottom();</script>
{% endif %}
{% endblock %}
