{% extends 'user/base-min.html' %} {% block content %}
<!-- AI Chat Bot Page -->

<div style="display:flex; flex-direction:row;gap:15px; margin-bottom:20px;">
    <svg width="57" height="56" viewBox="0 0 57 56" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- Your SVG code remains the same -->
        <path d="M51.9725 32.2535C54.3799 19.3447 45.6728 6.89178 32.525 4.43975C19.3772 1.98772 6.7666 10.465 4.35916 23.3737C1.95171 36.2824 10.6589 48.7354 23.8067 51.1874L46.9641 55.5062L43.7422 46.1233C48.0544 42.5965 50.9659 37.6899 51.9725 32.2535Z" fill="white"/>
        <path d="M14.9164 27.0168V40.5406H41.5974L41.474 27.0168L40.2 20.4509L17.1704 21.7249L14.9164 27.0168Z" fill="#F7D5B1"/>
        <path d="M9.23244 16.1385L14.9164 27.0164L17.1703 21.7244L40.1999 20.4505L41.4739 27.0164L44.3159 17.2165L38.142 15.9425L40.1019 12.8066L36.721 13.2476L40.1509 8.54366L33.0951 11.7776L36.525 4.91772L26.1372 11.4836L25.1572 8.73966L9.23244 16.1385Z" fill="#52504D"/>
        <path d="M14.9412 40.3388V46.0213H41.2018V40.3125L14.9412 40.3388Z" fill="white"/>
        <path d="M17.6604 40.4421L28.2442 51.026L38.7301 40.4421H17.6604Z" fill="#E8EAEB"/>
        <path d="M18.3463 40.4421L22.1683 44.9501L28.1462 40.5401L34.2221 44.9501L38.044 40.4421H18.3463Z" fill="white"/>
        <path d="M28.1462 40.5403L26.0882 42.0103V42.5003H30.4001V42.0103L28.1462 40.5403Z" fill="#C95C1C"/>
        <path d="M28.0715 50.5885H31.4968L30.4001 42.5002H26.0882L25.2171 50.5885H28.0715Z" fill="#FF5E00"/>
        <path d="M28.3975 36.0812C30.3947 36.0812 32.2856 34.0523 32.0847 33.1945C31.8838 32.3367 30.3947 33.1945 28.3975 33.1945C26.4002 33.1945 24.9525 32.1927 24.852 33.1945C24.7516 34.1964 26.3588 35.9372 28.3975 36.0812Z" fill="#3B3731"/>
        <path d="M20.6335 28.1925C21.283 28.1925 21.8095 27.666 21.8095 27.0166C21.8095 26.3671 21.283 25.8406 20.6335 25.8406C19.9841 25.8406 19.4576 26.3671 19.4576 27.0166C19.4576 27.666 19.9841 28.1925 20.6335 28.1925Z" fill="#3B3731"/>
        <path d="M35.6275 28.1925C36.277 28.1925 36.8035 27.666 36.8035 27.0166C36.8035 26.3671 36.277 25.8406 35.6275 25.8406C34.978 25.8406 34.4515 26.3671 34.4515 27.0166C34.4515 27.666 34.978 28.1925 35.6275 28.1925Z" fill="#3B3731"/>
        <path d="M14.9164 27.0168V40.5406H41.5974L41.474 27.0168L40.2 20.4509L17.1704 21.7249L14.9164 27.0168Z" fill="#F7D5B1"/>
        <path d="M9.23244 16.1385L14.9164 27.0164L17.1703 21.7244L40.1999 20.4505L41.4739 27.0164L44.3159 17.2165L38.142 15.9425L40.1019 12.8066L36.721 13.2476L40.1509 8.54366L33.0951 11.7776L36.525 4.91772L26.1372 11.4836L25.1572 8.73966L9.23244 16.1385Z" fill="#52504D"/>
        <path d="M14.9412 40.3388V46.0213H41.2018V40.3125L14.9412 40.3388Z" fill="white"/>
        <path d="M17.6604 40.4421L28.2442 51.026L38.7301 40.4421H17.6604Z" fill="#E8EAEB"/>
        <path d="M18.3463 40.4421L22.1683 44.9501L28.1462 40.5401L34.2221 44.9501L38.044 40.4421H18.3463Z" fill="white"/>
        <path d="M28.1462 40.5403L26.0882 42.0103V42.5003H30.4001V42.0103L28.1462 40.5403Z" fill="#C95C1C"/>
        <path d="M28.0715 50.5885H31.4968L30.4001 42.5002H26.0882L25.2171 50.5885H28.0715Z" fill="#FF5E00"/>
        <path d="M28.3975 36.0812C30.3947 36.0812 32.2856 34.0523 32.0847 33.1945C31.8838 32.3367 30.3947 33.1945 28.3975 33.1945C26.4002 33.1945 24.9525 32.1927 24.852 33.1945C24.7516 34.1964 26.3588 35.9372 28.3975 36.0812Z" fill="#3B3731"/>
        <path d="M20.6335 28.1925C21.283 28.1925 21.8095 27.666 21.8095 27.0166C21.8095 26.3671 21.283 25.8406 20.6335 25.8406C19.9841 25.8406 19.4576 26.3671 19.4576 27.0166C19.4576 27.666 19.9841 28.1925 20.6335 28.1925Z" fill="#3B3731"/>
        <path d="M35.6275 28.1925C36.277 28.1925 36.8035 27.666 36.8035 27.0166C36.8035 26.3671 36.277 25.8406 35.6275 25.8406C34.978 25.8406 34.4515 26.3671 34.4515 27.0166C34.4515 27.666 34.978 28.1925 35.6275 28.1925Z" fill="#3B3731"/>
    </svg>

    <p style="color: #FFF; font-size: 16px; font-style: normal; font-weight: 400; line-height: 20px; letter-spacing: -0.32px;">
        Hello, I'm Mr. GO!
        <br/>
        How can I help you today?
    </p>
</div>

<div class="chat__page" style="min-height: 100%; display: flex; justify-content: flex-start; padding-bottom: 36px; width: 100%; flex-direction: column; position: relative; z-index: 3;">
    <!-- Text Input Form -->
    <div style="padding-left: 3px; height: 100%; display: flex; flex-direction: column; align-items: flex-start; justify-content: flex-start; gap: 1rem; width: 100%;">
        <form id="subjectForm"  style="width: 100%;">
            <div style="display: flex; flex-direction: column; gap: 0.5rem; width: 100%;">
                <textarea 
                    id="initial_msg" 
                    name="initial_msg" 
                    placeholder="Send a message..."
                    style="
                        width: 100%;
                        min-height: 100px;
                        padding: 12px 16px;
                        border-radius: 6px;
                        border: 2px solid var(--goglobe-main-color);
                        font-family: var(--goglobe-body-font-family) !important;
                        font-size: 15px !important;
                        background: var( --goglobe-site-bg-color);
                        color: white;
                        resize: vertical;
                        box-sizing: border-box;
                    "
                    required
                ></textarea>
                <div id="call-btn-target"></div>
                <button 
                    hx-post="{{settings['backend_url']}}/min/login/"
                    hx-target="#chatbox"
                    hx-trigger="click"
                    hx-swap="innerHTML"
                    type="submit"
                    style="
                        font-family: var(--goglobe-body-font-family) !important;
                        font-size: 15px !important;
                        padding: 12px 24px;
                        border-radius: 6px;
                        border: 2px solid var(--goglobe-border-color);
                        cursor: pointer;
                        font-weight: bold;
                        background: var(--goglobe-main-color);
                        color: white;
                        transition: all 0.1s ease-in-out;
                        align-self: flex-end;
                    "
                    onMouseOver="this.style.opacity=0.7"
                    onMouseOut="this.style.opacity=1"
                >
                    Start Your Project
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function hideReturnChatButton() {
    const returnButton = document.getElementById('return-chat');
    if (returnButton) {
        returnButton.style.display = 'none';
        
        if (typeof htmx !== 'undefined') {
            htmx.process(returnButton);
        }
    }
}

// Optional: Add form submission handling
document.getElementById('subjectForm').addEventListener('submit', function(e) {
    // Form will be submitted to /login with the subject in the request body
    // You can add additional validation here if needed
    const subjectInput = document.getElementById('subjectInput');
    if (subjectInput.value.trim() === '') {
        e.preventDefault();
        alert('Please enter a subject or question.');
        subjectInput.focus();
    }
});

hideReturnChatButton();
</script>

<!-- vapi script -->
<script>
  const assistant = "{{ assistant }}"; // Read from environment variable VAPI_ASSISTANT
  const apiKey = "{{ api_key }}"; // Read from environment variable VAPI_KEY

  var vapiInstance = null;

  const buttonConfig = {
    position: "top-left", // "bottom" | "top" | "left" | "right" | "top-right" | "top-left" | "bottom-left" | "bottom-right"
    offset: "10px", // decide how far the button should be from the edge
    width: "20px", // min-width of the button
    height: "30px", // height of the button
    idle: {
      // button state when the call is not active.
      type: "pill", // or "round"
      title: 'Or talk to AI Operator ', // only required in case of Pill
      subtitle: " ", // only required in case of pill
      icon: `https://unpkg.com/lucide-static@0.321.0/icons/phone.svg`,
    },
    loading: {
      // button state when the call is connecting
      type: "pill", // or "round"
      title: "Connecting...", // only required in case of Pill
      subtitle: " ", // only required in case of pill
      icon: `https://unpkg.com/lucide-static@0.321.0/icons/loader-2.svg`,
    },
    active: {
      // button state when the call is in progress or active.
      type: "pill", // or "round"
      title: "Call is in progress...Click to cancel", // only required in case of Pill
      subtitle: " ", // only required in case of pill
      icon: `https://unpkg.com/lucide-static@0.321.0/icons/phone-off.svg`,
    },
  };

  (function (d, t) {
    var g = document.createElement(t),
      s = d.getElementsByTagName(t)[0];
    g.src =
      "https://cdn.jsdelivr.net/gh/VapiAI/html-script-tag@latest/dist/assets/index.js";
    g.defer = true;
    g.async = true;
    s.parentNode.insertBefore(g, s);

    g.onload = function () {
      const vapi = window.vapiSDK.run({
        apiKey: apiKey, // required
        assistant: assistant, // required
        config: buttonConfig, // optional
      });

      if (vapi) {
        // Extend more using vapi
        window.vapiSDK.vapi = vapi;
        vapiInstance = vapi;

        vapiInstance.on("speech-start", () => {
          console.log("Speech has started");
        });

        vapiInstance.on("speech-end", () => {
          console.log("Speech has ended");
        });

        vapiInstance.on("call-start", () => {
          console.log("Call has started");
        });

        vapiInstance.on("call-end", () => {
          console.log("Call has stopped");
        });

        vapiInstance.on("volume-level", (volume) => {
          console.log(`Assistant volume level: ${volume}`);
        });

        // Function calls and transcripts will be sent via messages
        vapiInstance.on("message", (message) => {
          console.log(message);
        });

        vapiInstance.on("error", (e) => {
          console.error(e);
        });
      }
    };
  })(document, "script");

  function logUserAction() {
    // Function to log the user action

    if (window.vapiSDK.vapi)
      window.vapiSDK.vapi.send({
        type: "add-message",
        message: {
          role: "system",
          content: "The user has pressed the button, say peanuts",
        },
      });
    else {
      console.log(window.vapiSDK, vapiInstance);
    }
  }

  // Move the full Vapi support button element (including its children) into #target
  (function moveVapiSupportBtnIntoTargetWhenReady() {
    const TARGET_ID = "call-btn-target";
    const BTN_ID = "vapi-support-btn";

    const tryMove = () => {
      const target = document.getElementById(TARGET_ID);
      const btn = document.getElementById(BTN_ID);
      // Don't make it a submit button to avoid submitting the form
      if (btn && btn.tagName.toLowerCase() === "button") {
          btn.setAttribute("type", "button");
      }

      if (!target || !btn) return false;
      if (btn.parentElement === target) return true;
      target.appendChild(btn); // appendChild moves the existing node (keeps all content)
      return true;
    };

    if (tryMove()) return;

    const obs = new MutationObserver(() => {
      if (tryMove()) obs.disconnect();
    });

    obs.observe(document.documentElement, { childList: true, subtree: true });

    // Safety timeout to avoid observing forever
    setTimeout(() => obs.disconnect(), 15000);
  })();
</script>
{% endblock %}
