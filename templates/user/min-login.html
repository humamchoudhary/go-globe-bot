{% extends 'user/base.html' %}
{% block content %}

<style>
  input:invalid, select:invalid {
    border-color: #ef4444;
  }

  .error-text {
    color: #ef4444;
    font-size: 0.875rem;
    margin-top: 0.25rem;
  }

  .hidden {
    display: none !important;
  }

  .input-error {
    border-color: #ef4444 !important;
  }
</style>

<div style="background-color: var(--techwave-site-bg-color); color: var(--techwave-body-color); font-family: var(--techwave-body-font-family);">
  <div>
    <div style="border-radius: 0.5rem; padding: 2rem 2rem 0;">
      <p id="error-message" class="error-text hidden"></p>

      <form id="login-form" novalidate>
        <!-- Name -->
        <div style="margin-bottom: 1rem;">
          <label for="name">Name *</label>
          <input type="text" id="name" name="name" required minlength="2"
            style="width: 100%; padding: 0.75rem; border: 1px solid var(--techwave-border-color); border-radius: 0.25rem;"
            placeholder="Enter your name">
          <p id="name-error" class="error-text hidden"></p>
        </div>

        <!-- Email -->
        <div style="margin-bottom: 1rem;">
          <label for="email">Email *</label>
          <input type="email" id="email" name="email" required
            pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
            style="width: 100%; padding: 0.75rem; border: 1px solid var(--techwave-border-color); border-radius: 0.25rem;"
            placeholder="Enter your email">
          <p id="email-error" class="error-text hidden"></p>
        </div>

        <!-- Subject -->
        <div style="margin-bottom: 1rem;">
          <label for="subject">Message Subject*</label>
          <select id="subject" name="subject" required
            style="width: 100%; padding: 0.75rem; border: 1px solid var(--techwave-border-color); border-radius: 0.25rem;">
            {% for subject in settings['subjects'] %}
              <option {% if default_subject == subject %} selected {% endif %}>{{ subject }}</option>
            {% endfor %}
          </select>
          <p id="subject-error" class="error-text hidden"></p>
        </div>

        <!-- Designation -->
        <div style="margin-bottom: 1rem;">
          <label for="desg">Designation*</label>
          <input type="text" id="desg" name="desg"
            style="width: 100%; padding: 0.75rem; border: 1px solid var(--techwave-border-color); border-radius: 0.25rem;"
            placeholder="Enter your designation">
        </div>

        <!-- Phone -->
        <div style="margin-bottom: 1.5rem;">
          <label for="phone">Phone *</label>
          <input type="tel" id="phone" name="phone" required pattern="[0-9+\-\s()]{10,15}"
            style="width: 100%; padding: 0.75rem; border: 1px solid var(--techwave-border-color); border-radius: 0.25rem;"
            placeholder="Enter your phone number">
          <p id="phone-error" class="error-text hidden"></p>
          <p style="font-size: 0.875rem; color: #6b7280;">Format: 10-15 digits, may include +, -, (, ), and spaces</p>
        </div>

        <!-- Submit -->
        <button type="submit" id="login-btn"
          style="width: 100%; padding: 0.75rem; background-color: var(--techwave-button-bg-color); color: var(--techwave-body-color); font-weight: 700; border-radius: 0.25rem;">
          Start Chat
        </button>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const loginForm = document.getElementById("login-form");
    const nameInput = document.getElementById("name");
    const emailInput = document.getElementById("email");
    const subjectInput = document.getElementById("subject");
    const desgInput = document.getElementById("desg");
    const phoneInput = document.getElementById("phone");
    const errorMessage = document.getElementById("error-message");

    const nameError = document.getElementById("name-error");
    const emailError = document.getElementById("email-error");
    const subjectError = document.getElementById("subject-error");
    const phoneError = document.getElementById("phone-error");

    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    const phoneRegex = /^[0-9+\-\s()]{10,15}$/;

    function showInputError(inputElement, errorElement, message) {
      inputElement.classList.add("input-error");
      errorElement.textContent = message;
      errorElement.classList.remove("hidden");
    }

    function hideError(errorElement) {
      errorElement.textContent = "";
      errorElement.classList.add("hidden");
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.remove("hidden");
    }

    function validateForm() {
      let isValid = true;

      hideError(errorMessage);
      hideError(nameError);
      hideError(emailError);
      hideError(subjectError);
      hideError(phoneError);

      nameInput.classList.remove("input-error");
      emailInput.classList.remove("input-error");
      subjectInput.classList.remove("input-error");
      phoneInput.classList.remove("input-error");

      if (!nameInput.value.trim()) {
        showInputError(nameInput, nameError, "Name is required");
        isValid = false;
      } else if (nameInput.value.trim().length < 2) {
        showInputError(nameInput, nameError, "Name must be at least 2 characters");
        isValid = false;
      }

      if (!emailInput.value.trim()) {
        showInputError(emailInput, emailError, "Email is required");
        isValid = false;
      } else if (!emailRegex.test(emailInput.value.trim())) {
        showInputError(emailInput, emailError, "Please enter a valid email address");
        isValid = false;
      }

      if (!subjectInput.value.trim()) {
        showInputError(subjectInput, subjectError, "Subject is required");
        isValid = false;
      }

      if (!phoneInput.value.trim()) {
        showInputError(phoneInput, phoneError, "Phone number is required");
        isValid = false;
      } else if (!phoneRegex.test(phoneInput.value.trim())) {
        showInputError(phoneInput, phoneError, "Enter valid phone number (10-15 digits)");
        isValid = false;
      }

      return isValid;
    }

    loginForm.addEventListener("submit", function (e) {
      e.preventDefault();
      if (!validateForm()) return;

      const isHtmxRequest = document.getElementById("chatbox") !== null;

      fetch("{{ settings['backend_url'] }}/min/auth", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "HX-Request": isHtmxRequest
        },
        credentials: "include",
        body: JSON.stringify({
          name: nameInput.value.trim(),
          email: emailInput.value.trim(),
          phone: phoneInput.value.trim(),
          subject: subjectInput.value.trim(),
          desg: desgInput.value.trim()
        })
      })
        .then(async (response) => {
          if (!response.ok) {
            const data = await response.json();
            showError(data.error || "Login failed");
            return;
          }

          const text = await response.text();

          if (isHtmxRequest) {
            htmx.swap('#chatbox', text, { swapStyle: 'innerHTML' });
          } else {
            if (response.redirected) {
              window.location.href = response.url;
            } else {
              // Handle success
            }
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          showError("An error occurred. Please try again.");
        });
    });

    // Real-time error removal
    [nameInput, emailInput, subjectInput, phoneInput].forEach(input => {
      input.addEventListener("input", () => {
        input.classList.remove("input-error");
        hideError(document.getElementById(`${input.id}-error`));
      });
    });
  });
</script>
{% endblock %}
