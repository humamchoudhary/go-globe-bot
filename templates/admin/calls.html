{% extends 'admin/base.html' %}
{% block header %}
{{super()}}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}

{% set title = "Calls" %} 
{% block content %}
<style>
.call-list-scroll::-webkit-scrollbar {
    width: 6px;
}

.call-list-scroll::-webkit-scrollbar-track {
    background: transparent;
}

.call-list-scroll::-webkit-scrollbar-thumb {
    background-color: var(--border-color);
    border-radius: 3px;
}

.call-detail-scroll::-webkit-scrollbar {
    width: 6px;
}

.call-detail-scroll::-webkit-scrollbar-track {
    background: transparent;
}

.call-detail-scroll::-webkit-scrollbar-thumb {
    background-color: var(--border-color);
    border-radius: 3px;
}
</style>



<style>
#operator-status-widget {
    z-index: 9999;
    max-width: 350px;
}

#operator-status-widget.minimized #widget-content {
    display: none;
}

#operator-status-widget.minimized {
    min-width: auto;
}

@keyframes pulse-ring {
    0% {
        transform: scale(0.33);
    }
    80%, 100% {
        opacity: 0;
    }
}

#status-pulse.active {
    animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
}

/* Status dot colors */
.status-idle #status-dot { background-color: #9CA3AF; }
.status-idle #status-pulse { background-color: #9CA3AF; }

.status-connecting #status-dot { background-color: #F59E0B; }
.status-connecting #status-pulse { background-color: #F59E0B; }

.status-connected #status-dot { background-color: #10B981; }
.status-connected #status-pulse { background-color: #10B981; }

.status-incoming #status-dot { background-color: #3B82F6; }
.status-incoming #status-pulse { background-color: #3B82F6; }

.status-error #status-dot { background-color: #EF4444; }
.status-error #status-pulse { background-color: #EF4444; }

/* Quality bars animation */
.quality-excellent .quality-bar:nth-child(1),
.quality-excellent .quality-bar:nth-child(2),
.quality-excellent .quality-bar:nth-child(3),
.quality-excellent .quality-bar:nth-child(4) {
    background-color: #10B981;
}

.quality-good .quality-bar:nth-child(1),
.quality-good .quality-bar:nth-child(2),
.quality-good .quality-bar:nth-child(3) {
    background-color: #10B981;
}

.quality-fair .quality-bar:nth-child(1),
.quality-fair .quality-bar:nth-child(2) {
    background-color: #F59E0B;
}

.quality-poor .quality-bar:nth-child(1) {
    background-color: #EF4444;
}
</style>


<div class="flex flex-col w-full h-full items-center justify-center">
    <div class="flex flex-row w-full min-h-[80vh]">
        <!-- Call List Section -->
        <div class="flex flex-col gap-[25px] {% if call %}w-1/3 min-w-[400px]{% else %}w-full{% endif %} h-[93vh] overflow-y-scroll call-list-scroll transition-all duration-300">
            <div class="flex flex-row gap-[32px] items-start justify-between mx-[24px] mt-[24px]">
                <p class="text-[18px] md:text-[26px] text-[var(--sec-text)]">Calls</p>
                
                <!-- Dropdown Filter -->
                <div class="relative" id="call-dropdown">
                    <button 
                        id="dropdown-button"
                        class="flex items-center justify-between px-[18px] py-[8px] bg-[var(--sec-bg-color)] border border-[var(--border-color)] rounded-md text-[14px] font-bold hover:cursor-pointer min-w-[150px]"
                        onclick="toggleDropdown()"
                    >
                        <span id="selected-option">All Calls <span id="selected-count">({{ call_counts.all or calls|length }})</span></span>
                        <svg class="w-4 h-4 ml-2 transition-transform duration-200" id="dropdown-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <div 
                        id="dropdown-menu"
                        class="absolute top-full left-0 mt-1 w-max bg-[var(--sec-bg-color)] border border-[var(--border-color)] rounded-md shadow-lg z-50 hidden"
                    >
                        <div 
                            hx-get="/admin/calls/all?page=0"
                            hx-target="#call_list_container"
                            hx-trigger="click"
                            hx-on:click="selectOption(this, 'All Calls', '{{ call_counts.all or calls|length }}')"
                            hx-indicator="#loading-indicator"
                            class="dropdown-option px-[18px] py-[8px] text-[14px] hover:bg-[var(--border-color)] cursor-pointer flex flex-row gap-2 flex-nowrap justify-between"
                            data-value="all"
                        >
                            All Calls <span class="float-right">({{ call_counts.all or calls|length }})</span>
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <div class="flex flex-col" id="call_list_container">
                {% include 'components/call-list.html' %}
            </div>
        </div>
        
        <!-- Call Detail Section -->
        {% include "components/call.html" %}
    </div>
</div>


    <script src="/static/js/twilio.min.js"></script>

<script>
function toggleDropdown() {
    const dropdownMenu = document.getElementById('dropdown-menu');
    const dropdownIcon = document.getElementById('dropdown-icon');
    
    if (dropdownMenu.classList.contains('hidden')) {
        dropdownMenu.classList.remove('hidden');
        dropdownIcon.style.transform = 'rotate(180deg)';
    } else {
        dropdownMenu.classList.add('hidden');
        dropdownIcon.style.transform = 'rotate(0deg)';
    }
}

function selectOption(element, optionText, count) {
    const selectedOption = document.getElementById('selected-option');
    selectedOption.innerHTML = `${optionText} <span id="selected-count">(${count})</span>`;
    
    // Close dropdown
    document.getElementById('dropdown-menu').classList.add('hidden');
    document.getElementById('dropdown-icon').style.transform = 'rotate(0deg)';
    
    // Reset scroll position when switching options
    const callListContainer = document.getElementById('call_list_container');
    if (callListContainer) {
        callListContainer.scrollTop = 0;
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('call-dropdown');
    if (!dropdown.contains(event.target)) {
        document.getElementById('dropdown-menu').classList.add('hidden');
        document.getElementById('dropdown-icon').style.transform = 'rotate(0deg)';
    }
});

function updateCallCounts() {
    fetch('/admin/call-counts')
        .then(response => response.json())
        .then(data => {
            const selectedCount = document.getElementById('selected-count');
            const selectedOption = document.getElementById('selected-option').textContent;
            
            if (selectedOption.includes('All Calls')) {
                selectedCount.textContent = `(${data.all})`;
            } else if (selectedOption.includes('Ongoing Calls')) {
                selectedCount.textContent = `(${data.ongoing})`;
            } else if (selectedOption.includes('Ended Calls')) {
                selectedCount.textContent = `(${data.ended})`;
            } else if (selectedOption.includes('In Progress Calls')) {
                selectedCount.textContent = `(${data.in_progress})`;
            }
            
            const dropdownOptions = document.querySelectorAll('.dropdown-option');
            dropdownOptions.forEach(option => {
                const value = option.getAttribute('data-value');
                const countSpan = option.querySelector('span');
                if (countSpan) {
                    switch(value) {
                        case 'all':
                            countSpan.textContent = `(${data.all})`;
                            break;
                        case 'ongoing':
                            countSpan.textContent = `(${data.ongoing})`;
                            break;
                        case 'ended':
                            countSpan.textContent = `(${data.ended})`;
                            break;
                        case 'in_progress':
                            countSpan.textContent = `(${data.in_progress})`;
                            break;
                    }
                }
            });
        })
        .catch(error => console.error('Error updating call counts:', error));
}




function updateConferenceName(name) {
    const conferenceNameEl = document.getElementById('conference-name');
    if (conferenceNameEl) {
        conferenceNameEl.textContent = name || 'Unknown Conference';
    }
}





window.addEventListener("beforeunload", function (event) {
        reloadLock = false;
});





// Initialize when page loads
document.addEventListener("DOMContentLoaded", initOperatorDevice);





</script>




{% endblock %}
