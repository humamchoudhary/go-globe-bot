{% extends 'admin/template.html' %} 
<!-- templates/settings.html -->
{% block header_scripts %}

 <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>{% endblock %}
{% block content %}
<div class="container mx-auto py-10">
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-bold">Settings</h1>
        <button id="save-settings-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Settings</button>
    </div>

    <div class="space-y-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="space-y-6">
                <!-- Logo Settings -->
                <div class="border rounded-lg p-6 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4">Logo Settings</h2>
                    
                    <!-- Large Logo -->
                    <div class="space-y-2 mb-6">
                        <label for="large-logo" class="block text-sm font-medium">Large Logo</label>
                        <div id="large-logo-dropzone" class="border-2 border-dashed rounded-lg p-4 text-center border-border">
                            {% if settings.largeLogo %}
                            <div class="relative w-full h-32 flex items-center justify-center">
                                <img src="{{ settings.largeLogo }}" alt="Large Logo" class="max-h-32 object-contain">
                                <button onclick="removeLogo('large')" class="absolute top-0 right-0 bg-red-500 text-white rounded-full p-1" aria-label="Remove large logo">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                            {% else %}
                            <div class="py-4">
                                <div class="flex flex-col items-center">
                                    <i data-lucide="upload" class="h-10 w-10 text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-500 mb-1">Drag and drop your large logo here</p>
                                    <p class="text-xs text-gray-500 mb-3">PNG, JPG or SVG (recommended)</p>
                                    <div>
                                        <input id="large-logo" type="file" accept="image/*" class="hidden">
                                        <button onclick="document.getElementById('large-logo').click()" class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                                            Select File
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Small Logo -->
                    <div class="space-y-2">
                        <label for="small-logo" class="block text-sm font-medium">Small Logo (Favicon/Icon)</label>
                        <div id="small-logo-dropzone" class="border-2 border-dashed rounded-lg p-4 text-center border-border">
                            {% if settings.smallLogo %}
                            <div class="relative w-full flex items-center justify-center">
                                <img src="{{ settings.smallLogo }}" alt="Small Logo" class="h-12 w-12 object-contain">
                                <button onclick="removeLogo('small')" class="absolute top-0 right-0 bg-red-500 text-white rounded-full p-1" aria-label="Remove small logo">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                            {% else %}
                            <div class="py-4">
                                <div class="flex flex-col items-center">
                                    <i data-lucide="upload" class="h-8 w-8 text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-500 mb-1">Drag and drop your small logo here</p>
                                    <p class="text-xs text-gray-500 mb-3">Square format recommended (48x48px)</p>
                                    <div>
                                        <input id="small-logo" type="file" accept="image/*" class="hidden">
                                        <button onclick="document.getElementById('small-logo').click()" class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                                            Select File
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Subjects -->
                <div class="border rounded-lg p-6 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4">Subjects</h2>
                    <div class="space-y-4">
                        <div class="flex gap-2">
                            <input id="new-subject" type="text" placeholder="Add a new subject" class="flex-1 border rounded-md p-2">
                            <button id="add-subject-btn" class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="plus" class="h-4 w-4 mr-1 inline-block"></i>
                                Add
                            </button>
                        </div>

                        <div class="border rounded-md">
                            <ul id="subject-list" class="divide-y">
                                {% if settings.subjects|length == 0 %}
                                <li class="p-4 text-center text-gray-500">No subjects added yet</li>
                                {% else %}
                                {% for subject in settings.subjects %}
                                <li class="p-3 flex items-center justify-between" data-subject="{{ subject }}">
                                    <span class="flex-1">{{ subject }}</span>
                                    <div class="flex gap-1">
                                        <button class="p-1 text-gray-500 hover:text-gray-700 edit-subject" title="Edit">
                                            <i data-lucide="edit-2" class="h-4 w-4"></i>
                                        </button>
                                        <button class="p-1 text-gray-500 hover:text-red-500 delete-subject" title="Delete">
                                            <i data-lucide="trash-2" class="h-4 w-4"></i>
                                        </button>
                                    </div>
                                </li>
                                {% endfor %}
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <!-- API Keys -->
                <div class="border rounded-lg p-6 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4">API Keys</h2>
                    <div class="space-y-4">
                        {% for provider in ['openai', 'claude', 'gemini'] %}
                        <div class="space-y-2">
                            <label for="{{ provider }}-api-key" class="block text-sm font-medium capitalize">
                                {{ provider }} API Key
                            </label>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <input 
                                        id="{{ provider }}-api-key" 
                                        type="password" 
                                        value="{{ settings.apiKeys[provider] }}" 
                                        placeholder="Enter your {{ provider }} API key" 
                                        class="w-full border rounded-md p-2 pr-10"
                                    >
                                    <button 
                                        type="button" 
                                        class="toggle-password-visibility absolute right-0 top-0 h-full px-2"
                                        data-provider="{{ provider }}"
                                    >
                                        <i data-lucide="eye" class="h-4 w-4"></i>
                                    </button>
                                </div>
                                {% if settings.apiKeys[provider] %}
                                <button 
                                    type="button" 
                                    class="clear-api-key px-2 py-1 border border-gray-300 rounded-md"
                                    data-provider="{{ provider }}"
                                >
                                    <i data-lucide="trash-2" class="h-4 w-4 text-red-500"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        <div class="text-xs text-gray-500 mt-2">
                            Your API keys are stored securely and never shared with third parties.
                        </div>
                    </div>
                </div>

                <!-- Appearance -->
                <div class="border rounded-lg p-6 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4">Appearance</h2>
                    <div class="space-y-4">
                        <!-- Theme Selector -->
                        <div class="space-y-3">
                            <label class="block text-sm font-medium">Theme</label>
                            <div class="grid grid-cols-3 gap-4" id="theme-selector">
                                <div>
                                    <input type="radio" name="theme" value="light" id="theme-light" class="sr-only peer" {% if settings.theme == 'light' %}checked{% endif %}>
                                    <label for="theme-light" class="flex flex-col items-center justify-between rounded-md border-2 border-gray-200 bg-white p-4 hover:bg-gray-100 peer-checked:border-blue-500">
                                        <i data-lucide="sun" class="mb-3 h-6 w-6"></i>
                                        Light
                                    </label>
                                </div>

                                <div>
                                    <input type="radio" name="theme" value="dark" id="theme-dark" class="sr-only peer" {% if settings.theme == 'dark' %}checked{% endif %}>
                                    <label for="theme-dark" class="flex flex-col items-center justify-between rounded-md border-2 border-gray-200 bg-white p-4 hover:bg-gray-100 peer-checked:border-blue-500">
                                        <i data-lucide="moon" class="mb-3 h-6 w-6"></i>
                                        Dark
                                    </label>
                                </div>

                                <div>
                                    <input type="radio" name="theme" value="system" id="theme-system" class="sr-only peer" {% if settings.theme == 'system' %}checked{% endif %}>
                                    <label for="theme-system" class="flex flex-col items-center justify-between rounded-md border-2 border-gray-200 bg-white p-4 hover:bg-gray-100 peer-checked:border-blue-500">
                                        <i data-lucide="laptop" class="mb-3 h-6 w-6"></i>
                                        System
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Model Selection -->
                        <div class="pt-4 border-t">
                            <h3 class="text-lg font-medium mb-3">Model Selection</h3>
                            <div class="space-y-2">
                                <label for="model-select" class="block text-sm font-medium">AI Model</label>
                                <select id="model-select" class="w-full border rounded-md p-2">
                                    <option value="gemini" {% if settings.model == 'gemini' %}selected{% endif %}>Gemini</option>
                                    <option value="openai" disabled>OpenAI (Coming soon)</option>
                                    <option value="claude" disabled>Claude (Coming soon)</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">
                                    Currently only Gemini is available. More models will be added soon.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed right-4 top-4 bg-white border border-gray-200 shadow-md rounded-md p-4 max-w-xs hidden">
        <div class="flex">
            <div class="flex-1">
                <h3 id="toast-title" class="font-medium"></h3>
                <p id="toast-description" class="text-sm text-gray-500"></p>
            </div>
            <button onclick="hideToast()" class="text-gray-400 hover:text-gray-500">
                <i data-lucide="x" class="h-4 w-4"></i>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Current settings object
    let settings = {{ settings|tojson }};

    // File upload handling
    document.getElementById('large-logo').addEventListener('change', function(e) {
        handleFileUpload(e, 'large');
    });
    
    document.getElementById('small-logo').addEventListener('change', function(e) {
        handleFileUpload(e, 'small');
    });

    // Drag and drop handling
    const largeLogoDropzone = document.getElementById('large-logo-dropzone');
    const smallLogoDropzone = document.getElementById('small-logo-dropzone');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        largeLogoDropzone.addEventListener(eventName, preventDefaults, false);
        smallLogoDropzone.addEventListener(eventName, preventDefaults, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        largeLogoDropzone.addEventListener(eventName, () => highlight(largeLogoDropzone), false);
        smallLogoDropzone.addEventListener(eventName, () => highlight(smallLogoDropzone), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        largeLogoDropzone.addEventListener(eventName, () => unhighlight(largeLogoDropzone), false);
        smallLogoDropzone.addEventListener(eventName, () => unhighlight(smallLogoDropzone), false);
    });

    largeLogoDropzone.addEventListener('drop', (e) => handleDrop(e, 'large'), false);
    smallLogoDropzone.addEventListener('drop', (e) => handleDrop(e, 'small'), false);

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function highlight(element) {
        element.classList.add('border-blue-500', 'bg-blue-50');
    }

    function unhighlight(element) {
        element.classList.remove('border-blue-500', 'bg-blue-50');
    }

    function handleDrop(e, type) {
        const dt = e.dataTransfer;
        const file = dt.files[0];
        handleFile(file, type);
    }

    function handleFileUpload(e, type) {
        const file = e.target.files[0];
        handleFile(file, type);
    }

    function handleFile(file, type) {
        if (!file || !file.type.match('image.*')) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            settings[type + 'Logo'] = e.target.result;
            renderLogoSection();
        };
        reader.readAsDataURL(file);
    }

    function removeLogo(type) {
        settings[type + 'Logo'] = '';
        renderLogoSection();
    }

    function renderLogoSection() {
        // Re-render the page with updated settings
        // In a real implementation, you would update just the needed DOM elements
        // For simplicity, we'll just reload the page with updated settings
        fetch('/save-settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        }).then(() => {
            window.location.reload();
        });
    }

    // Subject list handling
    const newSubjectInput = document.getElementById('new-subject');
    const addSubjectBtn = document.getElementById('add-subject-btn');
    const subjectList = document.getElementById('subject-list');

    addSubjectBtn.addEventListener('click', addSubject);
    newSubjectInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            addSubject();
        }
    });
    
    // Disable add button if input is empty
    newSubjectInput.addEventListener('input', function() {
        addSubjectBtn.disabled = !newSubjectInput.value.trim();
    });
    
    // Initial button state
    addSubjectBtn.disabled = !newSubjectInput.value.trim();

    function addSubject() {
        const subject = newSubjectInput.value.trim();
        if (subject) {
            settings.subjects.push(subject);
            newSubjectInput.value = '';
            addSubjectBtn.disabled = true;
            renderSubjectList();
        }
    }

    function renderSubjectList() {
        // Clear the list
        subjectList.innerHTML = '';
        
        if (settings.subjects.length === 0) {
            subjectList.innerHTML = '<li class="p-4 text-center text-gray-500">No subjects added yet</li>';
            return;
        }
        
        // Add all subjects
        settings.subjects.forEach((subject, index) => {
            const li = document.createElement('li');
            li.className = 'p-3 flex items-center justify-between';
            li.dataset.subject = subject;
            li.innerHTML = `
                <span class="flex-1">${subject}</span>
                <div class="flex gap-1">
                    <button class="p-1 text-gray-500 hover:text-gray-700 edit-subject" title="Edit">
                        <i data-lucide="edit-2" class="h-4 w-4"></i>
                    </button>
                    <button class="p-1 text-gray-500 hover:text-red-500 delete-subject" title="Delete">
                        <i data-lucide="trash-2" class="h-4 w-4"></i>
                    </button>
                </div>
            `;
            subjectList.appendChild(li);
        });
        
        // Re-initialize Lucide icons
        lucide.createIcons();
        
        // Add event listeners to edit and delete buttons
        document.querySelectorAll('.edit-subject').forEach(btn => {
            btn.addEventListener('click', handleEditSubject);
        });
        
        document.querySelectorAll('.delete-subject').forEach(btn => {
            btn.addEventListener('click', handleDeleteSubject);
        });
    }

    function handleEditSubject(e) {
        const li = e.currentTarget.closest('li');
        const subject = li.dataset.subject;
        const index = settings.subjects.indexOf(subject);
        
        // Replace the content with an edit form
        li.innerHTML = `
            <div class="flex-1 flex gap-2">
                <input type="text" value="${subject}" class="flex-1 border rounded-md p-1 edit-subject-input">
                <div class="flex gap-1">
                    <button class="p-1 text-gray-500 hover:text-green-500 save-edit" title="Save">
                        <i data-lucide="check" class="h-4 w-4"></i>
                    </button>
                    <button class="p-1 text-gray-500 hover:text-gray-700 cancel-edit" title="Cancel">
                        <i data-lucide="x" class="h-4 w-4"></i>
                    </button>
                </div>
            </div>
        `;
        
        // Re-initialize Lucide icons
        lucide.createIcons();
        
        // Focus the input
        const input = li.querySelector('.edit-subject-input');
        input.focus();
        
        // Add event listeners
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                saveEdit(li, index);
            } else if (e.key === 'Escape') {
                cancelEdit(li, subject);
            }
        });
        
        li.querySelector('.save-edit').addEventListener('click', () => saveEdit(li, index));
        li.querySelector('.cancel-edit').addEventListener('click', () => cancelEdit(li, subject));
    }

    function saveEdit(li, index) {
        const input = li.querySelector('.edit-subject-input');
        const newValue = input.value.trim();
        
        if (newValue) {
            settings.subjects[index] = newValue;
            renderSubjectList();
        }
    }

    function cancelEdit(li, originalValue) {
        renderSubjectList();
    }

    function handleDeleteSubject(e) {
        const li = e.currentTarget.closest('li');
        const subject = li.dataset.subject;
        const index = settings.subjects.indexOf(subject);
        
        if (index !== -1) {
            settings.subjects.splice(index, 1);
            renderSubjectList();
        }
    }

    // API Keys handling
    document.querySelectorAll('.toggle-password-visibility').forEach(button => {
        button.addEventListener('click', function() {
            const provider = this.dataset.provider;
            const input = document.getElementById(`${provider}-api-key`);
            const icon = this.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.setAttribute('data-lucide', 'eye-off');
            } else {
                input.type = 'password';
                icon.setAttribute('data-lucide', 'eye');
            }
            
            // Re-initialize Lucide icons
            lucide.createIcons();
        });
    });

    document.querySelectorAll('.clear-api-key').forEach(button => {
        button.addEventListener('click', function() {
            const provider = this.dataset.provider;
            settings.apiKeys[provider] = '';
            document.getElementById(`${provider}-api-key`).value = '';
            this.style.display = 'none';
        });
    });

    document.querySelectorAll('#theme-selector input[name="theme"]').forEach(radio => {
        radio.addEventListener('change', function() {
            settings.theme = this.value;
            applyTheme(this.value);
        });
    });

    function applyTheme(theme) {
        const root = document.documentElement;
        root.classList.remove('light', 'dark');
        
        if (theme === 'system') {
            const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            root.classList.add(systemTheme);
        } else {
            root.classList.add(theme);
        }
    }

    // Apply theme on page load
    applyTheme(settings.theme);

    // Model selector
    document.getElementById('model-select').addEventListener('change', function() {
        settings.model = this.value;
    });

    // API key inputs
    document.querySelectorAll('#openai-api-key, #claude-api-key, #gemini-api-key').forEach(input => {
        input.addEventListener('input', function() {
            const provider = this.id.split('-')[0];
            settings.apiKeys[provider] = this.value;
            
            // Show/hide clear button
            const clearButton = this.parentElement.nextElementSibling;
            if (clearButton && clearButton.classList.contains('clear-api-key')) {
                clearButton.style.display = this.value ? 'block' : 'none';
            }
        });
    });

    // Save settings
    document.getElementById('save-settings-btn').addEventListener('click', function() {
        fetch('/save-settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Settings saved', 'Your settings have been saved successfully.');
            }
        });
    });

    // Toast functions
    function showToast(title, description) {
        const toast = document.getElementById('toast');
        document.getElementById('toast-title').textContent = title;
        document.getElementById('toast-description').textContent = description;
        toast.classList.remove('hidden');
        
        // Auto-hide after 3 seconds
        setTimeout(hideToast, 3000);
    }

    function hideToast() {
        document.getElementById('toast').classList.add('hidden');
    }
</script>

 <script>
        // Initialize Lucide icons
        lucide.createIcons();
    </script>
    {% endblock %}
