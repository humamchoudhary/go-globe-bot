{% extends 'admin/base.html' %} {% block content %}
<div class="px-6 py-8">
  <!-- Header Section -->
<div class="mb-8">
    <div class="flex items-center gap-3 mb-2">
      <div class="p-2 bg-[var(--border-color)] rounded-lg">
        <i data-lucide="database" class="w-6 h-6 text-[var(--main-color)]"></i>
      </div>
      <h1 class="text-3xl font-bold text-[var(--white)]">
        Database Connections
      </h1>
    </div>
    <p class="text-[var(--sec-text)] text-lg">
      Manage your database connections and query data
    </p>
  </div>

  <!-- Action Cards & Connections Grid -->
  <div
    class="grid text-wrap grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"
    id="connections-grid"
  >
    <!-- Add Connection Card -->
    <div
      class="group min-h-[300px] relative bg-[var(--bg-color)] border-2 border-dashed border-[var(--border-color)] hover:border-[var(--main-color)] rounded-xl p-6 cursor-pointer transition-all duration-300 hover:shadow-lg min-h-[200px] flex flex-col justify-center items-center"
      onclick="document.getElementById('add-connection-modal').classList.remove('hidden')"
    >
      <div
        class="w-16 h-16 mb-4 rounded-full bg-[var(--main-color)] flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform"
      >
        <i data-lucide="plus" class="w-8 h-8 text-[var(--white)]"></i>
      </div>
      <h3 class="font-semibold text-[var(--white)] text-center mb-1">
        Add Connection
      </h3>
      <p class="text-sm text-[var(--sec-text)] text-center">
        Create a new database connection
      </p>
    </div>

    <!-- Add this near your "Add Connection" card -->
    {% if crawler.connectors %}
    <div
      class="group min-h-[300px] relative bg-[var(--bg-color)] border-2 border-dashed border-[var(--border-color)] hover:border-[var(--main-color)] rounded-xl p-6 cursor-pointer transition-all duration-300 hover:shadow-lg min-h-[200px] flex flex-col justify-center items-center"
      onclick="openDataSelectionModal()"
    >
      <div
        class="w-16 h-16 mb-4 rounded-full bg-[var(--main-color)] flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform"
      >
        <i data-lucide="database" class="w-8 h-8 text-[var(--white)]"></i>
      </div>
      <h3 class="font-semibold text-[var(--white)] text-center mb-1">
        Select Data
      </h3>
      <p class="text-sm text-[var(--sec-text)] text-center">
        Choose data to save from your databases
      </p>
    </div>
    {% endif %}

    <!-- Existing Connections -->
    {% for name,connection in crawler.connectors.items() %}
    <div
      class="group relative bg-[var(--bg-color)] border border-[var(--border-color)] hover:border-[var(--main-color)] rounded-xl p-6 transition-all duration-300 hover:shadow-lg min-h-[200px] flex flex-col"
      onclick="event.stopPropagation();openDataSelectionModal('{{name}}')"
    >
      <div class="flex items-center gap-3 mb-4">
        <div
          class="w-12 h-12 rounded-full bg-[var(--sec-bg-color)] flex items-center justify-center"
        >
          <i
            data-lucide="{% if connection.type == 'mysql' %}database{% else %}hard-drive{% endif %}"
            class="w-5 h-5 text-[var(--main-color)]"
          ></i>
        </div>
        <div>
          <h3 class="font-semibold text-[var(--white)]">{{ name }}</h3>
          <p class="text-xs text-[var(--sec-text)]">
            {{ connection.type|upper }} â€¢ {{ connection.connection_config.host}}
          </p>
        </div>
      </div>

      <div class="mt-auto">
        <div class="flex items-center gap-2 mb-3">
          <div
            class="h-2 w-2 rounded-full {% if connection.is_connected %}bg-green-500{% else %}bg-red-500{% endif %}"
          ></div>
          <span class="text-xs text-[var(--sec-text)]">
            {% if connection.is_connected %}CONNECTED{% else %}DISCONNECTED{%
            endif %}
          </span>
        </div>

        <div class="flex gap-2">
          <button
            hx-post="/admin/test_db/{{name}}"
            hx-on::after-request="window.location.reload()"
            hx-swap="none"
            class="flex-1 py-2 text-xs font-medium rounded-lg border border-[var(--border-color)] hover:bg-[var(--sec-bg-color)] text-[var(--sec-text)] transition-colors flex items-center justify-center gap-1"
            onclick="event.stopPropagation()"
          >
            <i data-lucide="wifi" class="w-3 h-3"></i> Test
          </button>
          <button
            onclick="event.stopPropagation(); deleteConnection('{{name }}')"
            class="flex-1 py-2 text-xs font-medium rounded-lg border border-red-500 hover:bg-red-500/10 text-red-500 transition-colors flex items-center justify-center gap-1"
          >
            <i data-lucide="trash-2" class="w-3 h-3"></i>
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Add Connection Modal -->
  <div
    id="add-connection-modal"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden"
  >
    <div
      class="relative bg-[var(--bg-color)] rounded-xl shadow-2xl p-6 w-full max-w-2xl mx-4 border border-[var(--border-color)] max-h-[90vh] overflow-y-auto"
    >
      <button
        onclick="document.getElementById('add-connection-modal').classList.add('hidden')"
        class="absolute top-4 right-4 p-2 rounded-full hover:bg-[var(--border-color)] transition-colors"
      >
        <i data-lucide="x" class="w-5 h-5 text-[var(--sec-text)]"></i>
      </button>

      <div class="mb-6">
        <div class="flex items-center gap-3 mb-2">
          <div
            class="w-10 h-10 bg-[var(--main-color)] rounded-lg flex items-center justify-center"
          >
            <i data-lucide="database" class="w-5 h-5 text-[var(--white)]"></i>
          </div>
          <h3 class="text-xl font-bold text-[var(--white)]">
            Add Database Connection
          </h3>
        </div>
        <p class="text-[var(--sec-text)]">
          Configure a new database connection
        </p>
      </div>

      <form
        id="connection-form"
        hx-post="/admin/add_database_connection"
        hx-swap="none"
        hx-on::after-request="handleConnectionResponse(event)"
      >
        <div class="space-y-6">
          <!-- Connection Type -->
          <div>
            <label class="block text-sm font-medium text-[var(--sec-text)] mb-2"
              >Database Type</label
            >
            <div class="grid grid-cols-2 gap-3">
              <label
                class="flex items-center gap-3 p-4 border border-[var(--border-color)] rounded-lg cursor-pointer hover:border-[var(--main-color)] transition-colors"
              >
                <input
                  type="radio"
                  name="type"
                  value="mysql"
                  class="text-[var(--main-color)]"
                  checked
                  onchange="toggleConnectionFields()"
                />
                <div>
                  <div class="flex items-center gap-2">
                    <i
                      data-lucide="database"
                      class="w-4 h-4 text-[var(--main-color)]"
                    ></i>
                    <span class="font-medium text-[var(--white)]">MySQL</span>
                  </div>
                  <p class="text-xs text-[var(--sec-text)] mt-1">
                    Connect to MySQL database
                  </p>
                </div>
              </label>
              <label
                class="flex items-center gap-3 p-4 border border-[var(--border-color)] rounded-lg cursor-pointer hover:border-[var(--main-color)] transition-colors"
              >
                <input
                  type="radio"
                  name="type"
                  value="mongodb"
                  class="text-[var(--main-color)]"
                  onchange="toggleConnectionFields()"
                />
                <div>
                  <div class="flex items-center gap-2">
                    <i
                      data-lucide="hard-drive"
                      class="w-4 h-4 text-[var(--main-color)]"
                    ></i>
                    <span class="font-medium text-[var(--white)]">MongoDB</span>
                  </div>
                  <p class="text-xs text-[var(--sec-text)] mt-1">
                    Connect to MongoDB using URI
                  </p>
                </div>
              </label>
            </div>
          </div>

          <!-- Connection Name -->
          <div>
            <label
              for="name"
              class="block text-sm font-medium text-[var(--sec-text)] mb-2"
              >Connection Name</label
            >
            <input
              type="text"
              id="name"
              name="name"
              required
              class="w-full px-4 py-3 bg-[var(--sec-bg-color)] border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--main-color)] focus:border-transparent text-[var(--white)]"
              placeholder="My Production DB"
            />
          </div>

          <!-- Standard Fields (MySQL) -->
          <div id="standard-fields" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                for="host"
                class="block text-sm font-medium text-[var(--sec-text)] mb-2"
                >Host</label
              >
              <input
                type="text"
                id="host"
                name="host"
                class="w-full px-4 py-3 bg-[var(--sec-bg-color)] border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--main-color)] focus:border-transparent text-[var(--white)]"
                placeholder="localhost"
              />
            </div>
            <div>
              <label
                for="port"
                class="block text-sm font-medium text-[var(--sec-text)] mb-2"
                >Port</label
              >
              <input
                type="number"
                id="port"
                name="port"
                class="w-full px-4 py-3 bg-[var(--sec-bg-color)] border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--main-color)] focus:border-transparent text-[var(--white)]"
                placeholder="3306"
              />
            </div>
            <div>
              <label
                for="username"
                class="block text-sm font-medium text-[var(--sec-text)] mb-2"
                >Username</label
              >
              <input
                type="text"
                id="username"
                name="username"
                class="w-full px-4 py-3 bg-[var(--sec-bg-color)] border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--main-color)] focus:border-transparent text-[var(--white)]"
                placeholder="(Optional)"
              />
            </div>
            <div>
              <label
                for="password"
                class="block text-sm font-medium text-[var(--sec-text)] mb-2"
                >Password</label
              >
              <input
                type="password"
                id="password"
                name="password"
                class="w-full px-4 py-3 bg-[var(--sec-bg-color)] border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--main-color)] focus:border-transparent text-[var(--white)]"
                placeholder="(Optional)"
              />
            </div>
<div class="md:col-span-2">
  <label
    for="database"
    class="block text-sm font-medium text-[var(--sec-text)] mb-2"
    >Database Name</label
  >
  <input
    type="text"
    id="database"
    name="database"
    class="w-full px-4 py-3 bg-[var(--sec-bg-color)] border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--main-color)] focus:border-transparent text-[var(--white)]"
    placeholder="Enter database name"
  />
</div>
          </div>

          <!-- MongoDB URI Field -->
          <div id="mongodb-uri-field" class="hidden space-y-4">
            <div>
              <label
                for="connection_uri"
                class="block text-sm font-medium text-[var(--sec-text)] mb-2"
                >MongoDB Connection URI</label
              >
              <input
                type="text"
                id="connection_uri"
                name="connection_uri"
                class="w-full px-4 py-3 bg-[var(--sec-bg-color)] border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--main-color)] focus:border-transparent text-[var(--white)]"
                placeholder="mongodb://username:password@host:port"
              />
              <p class="text-xs text-[var(--sec-text)] mt-2">
                Example formats: mongodb://localhost:27017 or mongodb+srv://user:pass@cluster.example.com
              </p>
            </div>
<div>
  <label
    for="mongodb_database"
    class="block text-sm font-medium text-[var(--sec-text)] mb-2"
    >Database Name</label
  >
  <input
    type="text"
    id="mongodb_database"
    name="mongodb_database"
    class="w-full px-4 py-3 bg-[var(--sec-bg-color)] border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--main-color)] focus:border-transparent text-[var(--white)]"
    placeholder="Enter database name"
  />
</div>
          </div>

          <!-- Test Connection -->
          <div
            id="test-connection-result"
            class="hidden p-4 rounded-lg border"
          ></div>

          <!-- Form Actions -->
          <div
            class="flex justify-between items-center pt-4 border-t border-[var(--border-color)]"
          >
            <button
              type="button"
              id="test-connection-btn"
              class="px-4 py-2 text-sm font-medium rounded-lg border border-[var(--border-color)] hover:bg-[var(--sec-bg-color)] text-[var(--sec-text)] transition-colors flex items-center gap-2"
            >
              <span>Test Connection</span>
              <div id="test-loading" class="htmx-indicator">
                <svg
                  class="animate-spin h-4 w-4 text-[var(--sec-text)]"
                  viewBox="0 0 24 24"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
              </div>
            </button>

            <div class="flex space-x-3">
              <button
                type="button"
                onclick="document.getElementById('add-connection-modal').classList.add('hidden')"
                class="px-4 py-2 text-sm font-medium rounded-lg border border-[var(--border-color)] hover:bg-[var(--sec-bg-color)] text-[var(--sec-text)] transition-colors"
              >
                Cancel
              </button>
              <button
                type="submit"
                class="px-6 py-2 text-sm font-medium rounded-lg bg-[var(--main-color)] hover:bg-opacity-90 text-[var(--white)] transition-colors flex items-center gap-2"
              >
                <span>Save Connection</span>
                <div id="save-loading" class="htmx-indicator">
                  <svg
                    class="animate-spin h-4 w-4 text-[var(--white)]"
                    viewBox="0 0 24 24"
                  >
                    <circle
                      class="opacity-25"
                      cx="12"
                      cy="12"
                      r="10"
                      stroke="currentColor"
                      stroke-width="4"
                    ></circle>
                    <path
                      class="opacity-75"
                      fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                    ></path>
                  </svg>
                </div>
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div
    id="data-selection-modal"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden"
  >
    <div
      class="relative bg-[var(--bg-color)] rounded-xl shadow-2xl p-6 w-full max-w-4xl mx-4 border border-[var(--border-color)] max-h-[90vh] flex flex-col"
    >
      <button
        onclick="document.getElementById('data-selection-modal').classList.add('hidden')"
        class="absolute top-4 right-4 p-2 rounded-full hover:bg-[var(--border-color)] transition-colors"
      >
        <i data-lucide="x" class="w-5 h-5 text-[var(--sec-text)]"></i>
      </button>

      <div class="mb-6">
        <h3 class="text-xl font-bold text-[var(--white)]">Select Data</h3>
        <p class="text-[var(--sec-text)]">Choose data to save</p>
      </div>

      <div class="flex-1 overflow-y-auto space-y-6 px-1">
        <!-- Connection Selection -->
        <div>
          <label class="block text-sm font-medium text-[var(--sec-text)] mb-2"
            >Database Connection</label
          >
          <select
            id="data-connection-select"
            class="w-full px-4 py-3 bg-[var(--sec-bg-color)] border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--main-color)] focus:border-transparent text-[var(--white)]"
            onchange="loadTablesForConnection(this.value)"
          >
            <option value="" disabled selected>Select a connection</option>
            {% for name,connection in crawler.connectors.items() %}
            <option value="{{ name }}">{{ name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Table Selection -->
        <div>
          <label class="block text-sm font-medium text-[var(--sec-text)] mb-2"
            >Table</label
          >
          <select
            id="data-table-select"
            class="w-full px-4 py-3 bg-[var(--sec-bg-color)] border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--main-color)] focus:border-transparent text-[var(--white)]"
            disabled
            onchange="loadTableData(this.value)"
          >
            <option value="" disabled selected>Select a table</option>
          </select>
        </div>

        <!-- Table Data Preview -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="block text-sm font-medium text-[var(--sec-text)]"
              >Data Preview (First 3 entries)</label
            >
            <button
              id="refresh-data-btn"
              onclick="refreshTableData()"
              class="text-xs flex items-center gap-1 text-[var(--sec-text)] hover:text-[var(--white)]"
            >
              <i data-lucide="refresh-ccw" class="w-3 h-3"></i>
              Refresh
            </button>
          </div>
          <div
            id="table-data-preview"
            class="bg-[var(--sec-bg-color)] border border-[var(--border-color)] rounded-lg p-4 max-h-60 overflow-y-auto"
          >
            <p class="text-sm text-[var(--sec-text)] text-center py-8">
              Select a table to preview data
            </p>
          </div>
        </div>

        <!-- Query Field -->
        <div>
          <label class="block text-sm font-medium text-[var(--sec-text)] mb-2"
            >Custom Query (Optional)</label
          >
          <textarea
            id="data-query-input"
            class="w-full px-4 py-3 bg-[var(--sec-bg-color)] border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--main-color)] focus:border-transparent text-[var(--white)]"
            placeholder="Enter your query (e.g., WHERE condition for SQL or JSON filter for MongoDB)"
            rows="3"
          ></textarea>
        </div>
      </div>

      <div
        class="pt-4 mt-4 border-t border-[var(--border-color)] flex justify-end"
      >
        <button
          onclick="document.getElementById('data-selection-modal').classList.add('hidden')"
          class="px-4 py-2 text-sm font-medium rounded-lg border border-[var(--border-color)] hover:bg-[var(--sec-bg-color)] text-[var(--sec-text)] transition-colors mr-3"
        >
          Cancel
        </button>
        <button
          id="save-data-btn"
          onclick="saveSelectedData()"
          class="px-6 py-2 text-sm font-medium rounded-lg bg-[var(--main-color)] hover:bg-opacity-90 text-[var(--white)] transition-colors flex items-center gap-2"
          disabled
        >
          <span>Save Data</span>
          <div id="save-data-loading" class="htmx-indicator">
            <svg
              class="animate-spin h-4 w-4 text-[var(--white)]"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- Saved Data Section -->
  <div class="mt-12">
    <div class="flex items-center gap-3 mb-6">
      <div class="p-2 bg-[var(--border-color)] rounded-lg">
        <i
          data-lucide="hard-drive"
          class="w-6 h-6 text-[var(--main-color)]"
        ></i>
      </div>
      <h2 class="text-2xl font-bold text-[var(--white)]">
        Saved Data Collections
      </h2>
    </div>

    <div id="saved-data-container" class="space-y-4">
      <!-- Collections will be loaded here -->
      <div class="text-center py-8">
        <i
          data-lucide="loader"
          class="w-8 h-8 mx-auto animate-spin text-[var(--sec-text)]"
        ></i>
        <p class="text-[var(--sec-text)] mt-2">Loading saved data...</p>
      </div>
    </div>
  </div>

 <div
    id="tables-modal"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden"
  >
    <div
      class="relative bg-[var(--bg-color)] rounded-xl shadow-2xl p-6 w-full max-w-2xl mx-4 border border-[var(--border-color)] max-h-[80vh] flex flex-col"
    >
      <button
        onclick="document.getElementById('tables-modal').classList.add('hidden')"
        class="absolute top-4 right-4 p-2 rounded-full hover:bg-[var(--border-color)] transition-colors"
      >
        <i data-lucide="x" class="w-5 h-5 text-[var(--sec-text)]"></i>
      </button>

      <div class="mb-6">
        <h3
          class="text-xl font-bold text-[var(--white)]"
          id="tables-modal-title"
        >
          Database Tables
        </h3>
        <p class="text-[var(--sec-text)]" id="tables-modal-subtitle">
          Loading tables...
        </p>
      </div>

      <div class="flex-1 overflow-y-auto">
        <div
          class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"
          id="tables-list"
        >
          <!-- Tables will be loaded here -->
        </div>
      </div>

      <div class="pt-4 mt-4 border-t border-[var(--border-color)]">
        <button
          onclick="document.getElementById('tables-modal').classList.add('hidden')"
          class="px-4 py-2 text-sm font-medium rounded-lg border border-[var(--border-color)] hover:bg-[var(--sec-bg-color)] text-[var(--sec-text)] transition-colors"
        >
          Close
        </button>
      </div>
    </div>
  </div>

  <div
    id="delete-modal"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden"
  >
    <div
      class="relative bg-[var(--bg-color)] rounded-xl shadow-2xl p-6 mx-4 border border-[var(--border-color)]"
    >
      <div class="text-center">
        <div
          class="w-16 h-16 mx-auto mb-4 bg-[var(--sec-bg-color)] rounded-full flex items-center justify-center"
        >
          <i data-lucide="trash-2" class="w-8 h-8 text-red-500"></i>
        </div>
        <h3 class="text-lg font-semibold text-[var(--white)] mb-2">
          Delete Connection
        </h3>
        <p class="text-[var(--sec-text)] mb-6">
          Are you sure you want to delete this connection? This action cannot be
          undone.
        </p>

        <div class="flex justify-center space-x-3">
          <button
            type="button"
            id="cancel-delete"
            class="px-4 py-2 text-sm font-medium rounded-lg border border-[var(--border-color)] hover:bg-[var(--sec-bg-color)] text-[var(--sec-text)] transition-colors"
          >
            Cancel
          </button>
          <button
            type="button"
            id="confirm-delete"
            class="px-4 py-2 text-sm font-medium rounded-lg bg-red-500 hover:bg-red-600 text-[var(--white)] transition-colors"
          >
            Delete
          </button>
        </div>
      </div>
    </div>
  </div>


</div>

<script>
  // Global variables
  let connectionToDelete = null;
  let currentConnection = null;
  let currentTable = null;

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    toggleConnectionFields();
    loadSavedData();
  });

  // Toggle between standard fields and MongoDB URI field
  function toggleConnectionFields() {
    const type = document.querySelector('input[name="type"]:checked').value;
    const uriField = document.getElementById('mongodb-uri-field');
    const standardFields = document.getElementById('standard-fields');
    
    if (type === 'mongodb') {
      uriField.classList.remove('hidden');
      standardFields.classList.add('hidden');
    } else {
      uriField.classList.add('hidden');
      standardFields.classList.remove('hidden');
    }
  }

  // Handle form submission response
  function handleConnectionResponse(event) {
    const xhr = event.detail.xhr;

    if (xhr.status === 200) {
      window.location.reload();
    } else {
      customAlert("Failed to save connection: " + xhr.responseText);
    }
  }

  // Test database connection
  document.getElementById("test-connection-btn").onclick = function () {
    const form = document.getElementById("connection-form");
    let formData = new FormData(form);
    const resultDiv = document.getElementById("test-connection-result");
    const type = document.querySelector('input[name="type"]:checked').value;

    // For MongoDB URI, we need to send different parameters
    if (type === 'mongodb') {
      const connectionData = {
        type: 'mongodb',
        name: formData.get('name'),
        connection_uri: formData.get('connection_uri'),
        database: formData.get('mongodb_database')
      };
      formData = new FormData();
      for (const key in connectionData) {
        formData.append(key, connectionData[key]);
      }
    }

    fetch("/admin/test_database_connection", {
      method: "POST",
      body: formData,
    })
      .then((response) => response.json())
      .then((data) => {
        resultDiv.classList.remove("hidden");
        if (data.status === "success") {
          resultDiv.classList.remove(
            "border-red-500",
            "bg-red-500/10",
            "text-red-500",
          );
          resultDiv.classList.add(
            "border-green-500",
            "bg-green-500/10",
            "text-green-500",
          );
          resultDiv.innerHTML = `
          <div class="flex items-center gap-2">
            <i data-lucide="check-circle" class="w-5 h-5"></i>
            <div>
              <p class="font-medium">Connection successful!</p>
              <p class="text-xs">${data.database_type} â€¢ ${data.database || "No database selected"}</p>
            </div>
          </div>
        `;
        } else {
          resultDiv.classList.remove(
            "border-green-500",
            "bg-green-500/10",
            "text-green-500",
          );
          resultDiv.classList.add(
            "border-red-500",
            "bg-red-500/10",
            "text-red-500",
          );
          resultDiv.innerHTML = `
          <div class="flex items-center gap-2">
            <i data-lucide="alert-circle" class="w-5 h-5"></i>
            <div>
              <p class="font-medium">Connection failed</p>
              <p class="text-xs">${data.message}</p>
            </div>
          </div>
        `;
        }
        lucide.createIcons();
      })
      .catch((error) => {
        resultDiv.classList.remove("hidden");
        resultDiv.classList.add(
          "border-red-500",
          "bg-red-500/10",
          "text-red-500",
        );
        resultDiv.innerHTML = `
        <div class="flex items-center gap-2">
          <i data-lucide="alert-circle" class="w-5 h-5"></i>
          <p class="font-medium">Error testing connection</p>
        </div>
      `;
        lucide.createIcons();
      });
  };

  // Show tables for a connection
  function showTables(connectionName) {
    const modal = document.getElementById("tables-modal");
    const title = document.getElementById("tables-modal-title");
    const subtitle = document.getElementById("tables-modal-subtitle");
    const tablesList = document.getElementById("tables-list");

    title.textContent = `${connectionName} Tables`;
    subtitle.textContent = "Loading tables...";
    tablesList.innerHTML =
      '<div class="col-span-3 py-8 text-center"><i data-lucide="loader" class="w-8 h-8 mx-auto animate-spin text-[var(--sec-text)]"></i></div>';
    modal.classList.remove("hidden");

    lucide.createIcons();

    fetch(
      `/admin/get_database_tables?connection=${encodeURIComponent(connectionName)}`,
    )
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        if (data.tables && data.tables.length > 0) {
          subtitle.textContent = `${data.tables.length} tables found`;
          tablesList.innerHTML = data.tables
            .map(
              (table) => `
                <div class="p-3 bg-[var(--sec-bg-color)] rounded-lg border border-[var(--border-color)] hover:border-[var(--main-color)] transition-colors">
                  <div class="flex items-center gap-2">
                    <i data-lucide="table" class="w-4 h-4 text-[var(--main-color)]"></i>
                    <span class="font-medium text-[var(--white)] truncate">${table}</span>
                  </div>
                </div>
              `,
            )
            .join("");
        } else {
          subtitle.textContent = "No tables found";
          tablesList.innerHTML = `
            <div class="col-span-3 py-8 text-center">
              <i data-lucide="database" class="w-8 h-8 mx-auto mb-2 text-[var(--sec-text)]"></i>
              <p class="text-[var(--sec-text)]">No tables or collections found in this database</p>
            </div>
          `;
        }
        lucide.createIcons();
      })
      .catch((error) => {
        subtitle.textContent = "Error loading tables";
        tablesList.innerHTML = `
          <div class="col-span-3 py-8 text-center">
            <i data-lucide="alert-circle" class="w-8 h-8 mx-auto mb-2 text-red-500"></i>
            <p class="text-[var(--sec-text)]">Failed to load tables: ${error.message}</p>
          </div>
        `;
        lucide.createIcons();
      });
  }

  // Delete connection
  function deleteConnection(connectionName) {
    connectionToDelete = connectionName;
    document.getElementById("delete-modal").classList.remove("hidden");
  }

  document.getElementById("cancel-delete").onclick = function () {
    document.getElementById("delete-modal").classList.add("hidden");
    connectionToDelete = null;
  };

  document.getElementById("confirm-delete").onclick = function () {
    if (connectionToDelete) {
      fetch(
        `/admin/delete_database_connection/${encodeURIComponent(connectionToDelete)}`,
        {
          method: "DELETE",
        },
      )
        .then((response) => {
          if (response.ok) {
            location.reload();
          } else {
            customAlert("Failed to delete connection");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          customAlert("Failed to delete connection");
        });
    }
    document.getElementById("delete-modal").classList.add("hidden");
    connectionToDelete = null;
  };

  // Close modals when clicking outside
  document.getElementById("add-connection-modal").onclick = function (e) {
    if (e.target === this) {
      this.classList.add("hidden");
    }
  };

  document.getElementById("tables-modal").onclick = function (e) {
    if (e.target === this) {
      this.classList.add("hidden");
    }
  };

  document.getElementById("delete-modal").onclick = function (e) {
    if (e.target === this) {
      this.classList.add("hidden");
    }
  };

  // Open data selection modal
  function openDataSelectionModal(connectionName = null) {
    const modal = document.getElementById("data-selection-modal");
    const connectionSelect = document.getElementById("data-connection-select");
    
    modal.classList.remove("hidden");
    currentConnection = connectionName || null;
    currentTable = null;
    
    if (connectionName) {
      connectionSelect.value = connectionName;
      loadTablesForConnection(connectionName);
    } else {
      connectionSelect.value = "";
      document.getElementById("data-table-select").disabled = true;
      document.getElementById("data-table-select").innerHTML = 
        '<option value="" disabled selected>Select a table</option>';
    }
    
    document.getElementById("table-data-preview").innerHTML =
      '<p class="text-sm text-[var(--sec-text)] text-center py-8">Select a table to preview data</p>';
    document.getElementById("data-query-input").value = "";
    document.getElementById("save-data-btn").disabled = true;
  }

  // Load tables for selected connection
  function loadTablesForConnection(connectionName) {
    const tableSelect = document.getElementById("data-table-select");
    const previewDiv = document.getElementById("table-data-preview");

    if (!connectionName) {
      tableSelect.disabled = true;
      tableSelect.innerHTML =
        '<option value="" disabled selected>Select a table</option>';
      previewDiv.innerHTML =
        '<p class="text-sm text-[var(--sec-text)] text-center py-8">Select a table to preview data</p>';
      document.getElementById("save-data-btn").disabled = true;
      return;
    }

    currentConnection = connectionName;
    tableSelect.disabled = true;
    tableSelect.innerHTML =
      '<option value="" disabled>Loading tables...</option>';
    previewDiv.innerHTML =
      '<p class="text-sm text-[var(--sec-text)] text-center py-8">Loading tables...</p>';

    fetch(
      `/admin/get_database_tables?connection=${encodeURIComponent(connectionName)}`,
    )
      .then((response) => response.json())
      .then((data) => {
        if (data.tables && data.tables.length > 0) {
          tableSelect.innerHTML =
            '<option value="" disabled selected>Select a table</option>';
          data.tables.forEach((table) => {
            tableSelect.innerHTML += `<option value="${table}">${table}</option>`;
          });
          tableSelect.disabled = false;
          previewDiv.innerHTML =
            '<p class="text-sm text-[var(--sec-text)] text-center py-8">Select a table to preview data</p>';
        } else {
          tableSelect.innerHTML =
            '<option value="" disabled>No tables found</option>';
          previewDiv.innerHTML =
            '<p class="text-sm text-[var(--sec-text)] text-center py-8">No tables found in this database</p>';
        }
        document.getElementById("save-data-btn").disabled = true;
      })
      .catch((error) => {
        tableSelect.innerHTML =
          '<option value="" disabled>Error loading tables</option>';
        previewDiv.innerHTML = `<p class="text-sm text-red-500 text-center py-8">Failed to load tables: ${error.message}</p>`;
        document.getElementById("save-data-btn").disabled = true;
      });
  }

  // Load data for selected table
  function loadTableData(tableName) {
    const previewDiv = document.getElementById("table-data-preview");

    if (!tableName || !currentConnection) {
      previewDiv.innerHTML =
        '<p class="text-sm text-[var(--sec-text)] text-center py-8">Select a table to preview data</p>';
      document.getElementById("save-data-btn").disabled = true;
      return;
    }

    currentTable = tableName;
    previewDiv.innerHTML =
      '<p class="text-sm text-[var(--sec-text)] text-center py-8">Loading data...</p>';

    fetchTableData();
  }

  // Refresh table data
  function refreshTableData() {
    if (!currentTable || !currentConnection) return;
    fetchTableData();
  }

  // Fetch table data with optional query
  function fetchTableData() {
    const previewDiv = document.getElementById("table-data-preview");
    const queryInput = document.getElementById("data-query-input").value;

    previewDiv.innerHTML =
      '<p class="text-sm text-[var(--sec-text)] text-center py-8">Loading data...</p>';

    fetch(`/admin/get_table_data`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        connection: currentConnection,
        table: currentTable,
        query: queryInput,
        limit: 3,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          previewDiv.innerHTML = `<p class="text-sm text-red-500 text-center py-8">${data.error}</p>`;
          document.getElementById("save-data-btn").disabled = true;
          return;
        }

        if (data.data && data.data.length > 0) {
          let html =
            '<div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="border-b border-[var(--border-color)]">';

          Object.keys(data.data[0]).forEach((key) => {
            html += `<th class="text-left py-2 px-3 text-[var(--sec-text)]">${key}</th>`;
          });

          html += "</tr></thead><tbody>";

          data.data.forEach((row) => {
            html += '<tr class="border-b border-[var(--border-color)]">';
            Object.values(row).forEach((value) => {
              let displayValue = value;
              if (value === null || value === undefined) {
                displayValue = "NULL";
              } else if (typeof value === "object") {
                displayValue = JSON.stringify(value);
              }
              html += `<td class="py-2 px-3 text-[var(--white)] truncate max-w-xs">${displayValue}</td>`;
            });
            html += "</tr>";
          });

          html += "</tbody></table></div>";
          html += `<p class="text-xs text-[var(--sec-text)] mt-2">Showing ${data.data.length} of ${data.row_count} rows</p>`;

          previewDiv.innerHTML = html;
          document.getElementById("save-data-btn").disabled = false;
        } else {
          previewDiv.innerHTML =
            '<p class="text-sm text-[var(--sec-text)] text-center py-8">No data found in this table</p>';
          document.getElementById("save-data-btn").disabled = false;
        }
      })
      .catch((error) => {
        previewDiv.innerHTML = `<p class="text-sm text-red-500 text-center py-8">Failed to load data: ${error.message}</p>`;
        document.getElementById("save-data-btn").disabled = true;
      });
  }

  // Save selected data
  function saveSelectedData() {
    if (!currentConnection || !currentTable) return;

    const saveBtn = document.getElementById("save-data-btn");
    const loadingIndicator = document.getElementById("save-data-loading");
    const queryInput = document.getElementById("data-query-input").value;

    saveBtn.disabled = true;
    loadingIndicator.classList.remove("htmx-indicator");

    fetch("/admin/save_data", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        connection: currentConnection,
        table: currentTable,
        query: queryInput,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          customAlert("Data saved successfully!");
          document.getElementById("data-selection-modal").classList.add("hidden");
          loadSavedData();
        } else {
          customAlert(`Failed to save data: ${data.error || "Unknown error"}`);
        }
      })
      .catch((error) => {
        customAlert(`Failed to save data: ${error.message}`);
      })
      .finally(() => {
        saveBtn.disabled = false;
        loadingIndicator.classList.add("htmx-indicator");
      });
  }

  // Query input event listener
  document.getElementById("data-query-input").addEventListener("keyup", function (e) {
    if (e.key === "Enter" && currentTable && currentConnection) {
      fetchTableData();
    }
  });

  // Load saved data collections
  function loadSavedData() {
    const container = document.getElementById("saved-data-container");
    container.innerHTML = `
      <div class="text-center py-8">
        <i data-lucide="loader" class="w-8 h-8 mx-auto animate-spin text-[var(--sec-text)]"></i>
        <p class="text-[var(--sec-text)] mt-2">Loading saved data...</p>
      </div>
    `;
    lucide.createIcons();

    fetch("/admin/get_saved_data")
      .then((response) => response.json())
      .then((data) => {
        if (data.collections && data.collections.length > 0) {
          renderSavedData(data.collections);
        } else {
          container.innerHTML = `
            <div class="text-center py-8 border border-[var(--border-color)] rounded-lg">
              <i data-lucide="database" class="w-8 h-8 mx-auto text-[var(--sec-text)]"></i>
              <p class="text-[var(--sec-text)] mt-2">No saved data collections found</p>
            </div>
          `;
          lucide.createIcons();
        }
      })
      .catch((error) => {
        container.innerHTML = `
          <div class="text-center py-8">
            <i data-lucide="alert-circle" class="w-8 h-8 mx-auto text-red-500"></i>
            <p class="text-[var(--sec-text)] mt-2">Failed to load saved data</p>
            <p class="text-xs text-red-500 mt-1">${error.message}</p>
          </div>
        `;
        lucide.createIcons();
      });
  }

  // Render saved data collections
  function renderSavedData(collections) {
    const container = document.getElementById("saved-data-container");
    container.innerHTML = "";

    collections.forEach((collection) => {
      const collectionElement = document.createElement("div");
      collectionElement.className =
        "bg-[var(--sec-bg-color)] border border-[var(--border-color)] rounded-lg overflow-hidden";

      collectionElement.innerHTML = `
        <div class="flex items-center justify-between p-4 cursor-pointer" onclick="toggleCollection(this)">
          <div class="flex items-center gap-3">
            <i data-lucide="database" class="w-5 h-5 text-[var(--main-color)]"></i>
            <div>
              <h3 class="font-medium text-[var(--white)]">${collection.connection_name}</h3>
              <p class="text-xs text-[var(--sec-text)]">${collection.tables.length} tables</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button 
              onclick="event.stopPropagation(); syncCollection('${collection.connection_name}')"
              class="p-2 rounded-lg hover:bg-[var(--border-color)] transition-colors text-[var(--sec-text)] hover:text-[var(--white)]"
              title="Sync all tables in this collection"
            >
              <i data-lucide="refresh-cw" class="w-4 h-4"></i>
            </button>
            <i data-lucide="chevron-down" class="w-5 h-5 text-[var(--sec-text)] transition-transform chevron-icon"></i>
          </div>
        </div>
        <div class="border-t border-[var(--border-color)] hidden collection-content">
          <div class="p-4 space-y-4" id="tables-${collection.connection_name}">
            <div class="text-center py-4">
              <i data-lucide="loader" class="w-5 h-5 mx-auto animate-spin text-[var(--sec-text)]"></i>
            </div>
          </div>
        </div>
      `;

      container.appendChild(collectionElement);
    });

    if (collections.length === 0) {
      container.innerHTML = `
        <div class="text-center py-8 border border-[var(--border-color)] rounded-lg">
          <i data-lucide="database" class="w-8 h-8 mx-auto text-[var(--sec-text)]"></i>
          <p class="text-[var(--sec-text)] mt-2">No saved data collections found</p>
        </div>
      `;
    }

    lucide.createIcons();
  }

  // Toggle collection expansion
  function toggleCollection(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector(".chevron-icon");

    if (content.classList.contains("hidden")) {
      content.classList.remove("hidden");
      if (icon) icon.classList.add("rotate-180");

      const connectionName = header.querySelector("h3").textContent.trim();
      const tablesContainer = document.getElementById(`tables-${connectionName}`);

      if (tablesContainer) {
        tablesContainer.innerHTML = `
          <div class="text-center py-4">
            <i data-lucide="loader" class="w-5 h-5 mx-auto animate-spin text-[var(--sec-text)]"></i>
          </div>
        `;
        lucide.createIcons();
        loadTablesForCollectionView(connectionName);
      }
    } else {
      content.classList.add("hidden");
      if (icon) icon.classList.remove("rotate-180");
    }
  }

  // Load tables for a collection
  function loadTablesForCollectionView(connectionName) {
    const tablesContainer = document.getElementById(`tables-${connectionName}`);

    fetch(
      `/admin/get_saved_tables?connection=${encodeURIComponent(connectionName)}`,
    )
      .then((response) => response.json())
      .then((data) => {
        if (data.tables && data.tables.length > 0) {
          tablesContainer.innerHTML = "";

          data.tables.forEach((table) => {
            const tableElement = document.createElement("div");
            tableElement.className =
              "bg-[var(--bg-color)] border border-[var(--border-color)] rounded-lg overflow-hidden mb-3";

            tableElement.innerHTML = `
              <div class="flex items-center justify-between p-3 cursor-pointer" 
                   onclick="toggleTable(this, '${connectionName}', '${table.name.replace("'", "\\'")}')">
                <div class="flex items-center gap-3">
                  <i data-lucide="table" class="w-4 h-4 text-[var(--main-color)]"></i>
                  <div>
                    <h4 class="font-medium text-[var(--white)]">${table.name}</h4>
                    <p class="text-xs text-[var(--sec-text)]">${table.row_count} rows â€¢ Saved ${table.saved_at}</p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <button 
                    onclick="event.stopPropagation(); syncTable('${connectionName}', '${table.name.replace("'", "\\'")}', '${table.query ? table.query.replace("'", "\\'") : ""}')"
                    class="p-1.5 rounded-lg hover:bg-[var(--border-color)] transition-colors text-[var(--sec-text)] hover:text-[var(--white)]"
                    title="Sync this table"
                  >
                    <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i>
                  </button>
                  <button 
                    class="p-2 rounded-lg hover:bg-[var(--border-color)] transition-colors text-red-400 hover:text-[var(--white)]"
                    hx-delete="/admin/delete_saved_table/${connectionName}/${table.name}"
                    onclick="event.stopPropagation()"
                    hx-on::after-request="window.location.reload()"
                    hx-swap="none"
                    hx-trigger="click"
                  >
                    <i data-lucide="trash" class="w-4 h-4"></i>
                  </button>
                  <i data-lucide="chevron-down" class="w-5 h-5 text-[var(--sec-text)] transition-transform"></i>
                </div>
              </div>
              <div class="border-t border-[var(--border-color)] hidden">
                <div class="p-3" id="data-${connectionName}-${table.name.replace(/[^a-zA-Z0-9]/g, "_")}">
                  <div class="text-center py-4">
                    <i data-lucide="loader" class="w-5 h-5 mx-auto animate-spin text-[var(--sec-text)]"></i>
                  </div>
                </div>
              </div>
            `;

            tablesContainer.appendChild(tableElement);
            htmx.process(tablesContainer);
          });

          lucide.createIcons();
        } else {
          tablesContainer.innerHTML = `
            <div class="text-center py-4 text-[var(--sec-text)]">
              No tables found in this collection
            </div>
          `;
        }
      })
      .catch((error) => {
        tablesContainer.innerHTML = `
          <div class="text-center py-4 text-red-500">
            Failed to load tables: ${error.message}
          </div>
        `;
      });
  }

  // Toggle table expansion
  function toggleTable(header, connectionName, tableName) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('i[data-lucide="chevron-down"]');

    if (content.classList.contains("hidden")) {
      content.classList.remove("hidden");
      if (icon) icon.classList.add("rotate-180");

      const safeTableName = tableName.replace(/[^a-zA-Z0-9]/g, "_");
      const dataContainer = document.getElementById(
        `data-${connectionName}-${safeTableName}`,
      );

      if (dataContainer && dataContainer.children.length === 1) {
        loadTableDataForDisplay(connectionName, tableName);
      }
    } else {
      content.classList.add("hidden");
      if (icon) icon.classList.remove("rotate-180");
    }
  }

  // Load table data for display
  function loadTableDataForDisplay(connectionName, tableName) {
    const safeTableName = tableName.replace(/[^a-zA-Z0-9]/g, "_");
    const dataContainer = document.getElementById(
      `data-${connectionName}-${safeTableName}`,
    );

    fetch(
      `/admin/get_saved_table_data?connection=${encodeURIComponent(connectionName)}&table=${encodeURIComponent(tableName)}`,
    )
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          dataContainer.innerHTML = `
            <div class="text-red-500 text-sm">
              ${data.error}
            </div>
          `;
          return;
        }

        if (data.data && data.data.length > 0) {
          let html = `
            <div class="overflow-x-auto">
              <table class="w-full text-sm" style="table-layout: fixed;">
                <thead>
                  <tr class="border-b border-[var(--border-color)]">
          `;

          Object.keys(data.data[0]).forEach((key) => {
            html += `<th class="text-left py-2 px-3 text-[var(--sec-text)] truncate" style="max-width: 200px;">${key}</th>`;
          });

          html += `
                  </tr>
                </thead>
                <tbody>
          `;

          data.data.slice(0, 5).forEach((row) => {
            html += '<tr class="border-b border-[var(--border-color)]">';
            Object.values(row).forEach((value) => {
              let displayValue = value;
              if (value === null || value === undefined) {
                displayValue = "NULL";
              } else if (typeof value === "object") {
                displayValue = JSON.stringify(value);
              }
              html += `<td class="py-2 px-3 text-[var(--white)] truncate" style="max-width: 200px;">${displayValue}</td>`;
            });
            html += "</tr>";
          });

          html += `
                </tbody>
              </table>
            </div>
            <style>
              #data-${connectionName}-${safeTableName} table {
                width: 100%;
              }
              #data-${connectionName}-${safeTableName} th,
              #data-${connectionName}-${safeTableName} td {
                max-width: 200px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
              }
            </style>
          `;

          if (data.data.length > 5) {
            html += `
              <div class="flex justify-between items-center mt-3">
                <p class="text-xs text-[var(--sec-text)]">
                  Showing 5 of ${data.data.length} rows
                </p>
              </div>
            `;
          }

          if (data.query) {
            html += `
              <div class="mt-3 p-2 bg-[var(--bg-color)] rounded-lg border border-[var(--border-color)]">
                <p class="text-xs text-[var(--sec-text)] mb-1">Query used:</p>
                <code class="text-xs text-[var(--white)] break-all">${data.query}</code>
              </div>
            `;
          }

          html += `
            <div class="mt-3 flex justify-end">
              <button 
                onclick="syncTable('${connectionName}', '${tableName.replace("'", "\\'")}', '${data.query ? data.query.replace("'", "\\'") : ""}')"
                class="flex items-center gap-1 px-3 py-1 text-xs rounded-lg border border-[var(--border-color)] hover:bg-[var(--border-color)] transition-colors"
              >
                <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                Sync Data
              </button>
            </div>
          `;

          dataContainer.innerHTML = html;
          lucide.createIcons();
        } else {
          dataContainer.innerHTML = `
            <div class="text-center py-4 text-[var(--sec-text)]">
              No data found in this table
            </div>
          `;
        }
      })
      .catch((error) => {
        dataContainer.innerHTML = `
          <div class="text-red-500 text-sm">
            Failed to load data: ${error.message}
          </div>
        `;
      });
  }

  function syncTable(connectionName, tableName, query) {
    if (
      confirm(
        `Are you sure you want to sync "${tableName}" in "${connectionName}"? This will overwrite the existing data.`,
      )
    ) {
      const saveBtn = document.querySelector(
        `button[onclick*="syncTable('${connectionName}', '${tableName.replace("'", "\\'")}'"]`,
      );
      if (saveBtn) {
        saveBtn.disabled = true;
        const icon = saveBtn.querySelector('i[data-lucide="refresh-cw"]');
        if (icon) icon.classList.add("animate-spin");
      }

      fetch("/admin/save_data", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          connection: connectionName,
          table: tableName,
          query: query,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            const safeTableName = tableName.replace(/[^a-zA-Z0-9]/g, "_");
            const dataContainer = document.getElementById(
              `data-${connectionName}-${safeTableName}`,
            );
            if (dataContainer && !dataContainer.classList.contains("hidden")) {
              loadTableDataForDisplay(connectionName, tableName);
            }
            alert(`Table "${tableName}" synced successfully!`);
          } else {
            alert(`Failed to sync table1: ${data.error || "Unknown error"}`);
          }
        })
        .catch((error) => {
          alert(`Failed to sync table2: ${error.message}`);
        })
        .finally(() => {
          const saveBtn = document.querySelector(
            `button[onclick*="syncTable('${connectionName}', '${tableName.replace("'", "\\'")}'"]`,
          );
          if (saveBtn) {
            saveBtn.disabled = false;
            const icon = saveBtn.querySelector('i[data-lucide="refresh-cw"]');
            if (icon) icon.classList.remove("animate-spin");
          }
        });
    }
  }

  // Sync an entire collection
  function syncCollection(connectionName) {
    if (
      confirm(
        `Are you sure you want to sync all tables in "${connectionName}"? This will overwrite existing data.`,
      )
    ) {
      customAlert(`Syncing all tables in ${connectionName}`);
    }
  }
</script>
{% endblock %}
